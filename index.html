<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Kehadiran Murid SKSA Tahap 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      padding: 12px 20px 14px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.4);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-main {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-logo {
      height: 48px;
      width: 48px;
      border-radius: 999px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .header-logo img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    .header-text h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
    }
    .header-text p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    main {
      max-width: 1040px;
      margin: 20px auto;
      padding: 0 16px 32px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .card-header h2 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
    }
    .date-display {
      font-size: 0.9rem;
      color: #4b5563;
    }
    label {
      font-size: 0.9rem;
      color: #374151;
    }
    select, button {
      font-size: 0.9rem;
    }
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
      background: white;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 16px rgba(15, 23, 42, 0.18);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
    }
    .btn-outline {
      background: white;
      color: #1f2937;
      border: 1px solid #d1d5db;
      box-shadow: none;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(15, 23, 42, 0.18);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.18);
    }
    .btn-icon {
      font-size: 1rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 0.8rem;
      color: #374151;
    }
    .pill strong {
      color: #111827;
    }

    /* Tabs utama */
    .tabs {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 4px;
    }
    .tab-btn {
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #4b5563;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s, border-color 0.15s;
    }
    .tab-btn:hover {
      background: #f3f4ff;
    }
    .tab-btn.active {
      background: #ffffff;
      color: #1d4ed8;
      font-weight: 600;
      border-color: #bfdbfe;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.2);
    }
    .tab-panel {
      margin-top: 12px;
    }

    /* Sub-tab dalam Ringkasan Semua Kelas */
    .subtabs {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .subtab-btn {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 4px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #4b5563;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s, border-color 0.15s;
    }
    .subtab-btn:hover {
      background: #eef2ff;
    }
    .subtab-btn.active {
      background: #ffffff;
      color: #2563eb;
      font-weight: 600;
      border-color: #bfdbfe;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.2);
    }
    .subtab-panel {
      margin-top: 8px;
    }

    /* carian nama */
    .search-row {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .search-row label {
      font-size: 0.85rem;
      white-space: nowrap;
    }
    .search-row input[type="text"] {
      flex: 1 1 220px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .search-row input[type="text"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
      background: white;
    }

    .students-container {
      margin-top: 12px;
      max-height: 420px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .students-header {
      display: grid;
      grid-template-columns: 52px 1fr 90px;
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .student-row {
      display: grid;
      grid-template-columns: 52px 1fr 90px;
      padding: 7px 12px;
      align-items: center;
      font-size: 0.9rem;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }
    .student-row:nth-child(even) {
      background: #f9fafb;
    }
    .student-row:hover {
      background: #eff6ff;
    }
    .student-name {
      font-weight: 500;
      color: #111827;
    }
    .checkbox-wrapper {
      display: flex;
      justify-content: center;
    }
    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .summary-box {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: 0.9rem;
      color: #1e3a8a;
    }
    .summary-main {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .summary-main strong {
      font-size: 1rem;
    }
    .summary-absent {
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .summary-absent ul {
      margin: 4px 0 0 18px;
      padding: 0;
    }
    .summary-absent li {
      margin: 0;
    }
    .status-bar {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.85rem;
    }
    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e5f9ed;
      color: #047857;
      font-weight: 600;
    }
    .status-pill.error {
      background: #fee2e2;
      color: #b91c1c;
    }
    .status-pill.info {
      background: #e0f2fe;
      color: #0369a1;
    }

    /* Jadual ringkasan semua kelas */
    .summary-header-row {
      font-size: 0.95rem;
      margin-top: 4px;
    }
    .summary-date-link {
      color: #2563eb;
      text-decoration: underline;
    }
    .summary-table-wrapper {
      margin-top: 10px;
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      background: white;
    }
    .summary-table th,
    .summary-table td {
      border: 1px solid #cbd5e1;
      padding: 6px 8px;
      text-align: left;
    }
    .summary-table th {
      background: #e5f0ff;
      color: #1f2937;
      font-weight: 600;
    }
    .summary-table td.main-row-cell {
      background: white;
    }
    .summary-table tr:nth-child(even) td.main-row-cell {
      background: #f9fafb;
    }
    .row-not-updated td.main-row-cell {
      background: #fff7ed;
    }
    .cell-not-updated {
      font-weight: 600;
      color: #b45309;
    }
    .attendance-link {
      cursor: pointer;
      text-decoration: underline;
      color: #111827;
    }
    .attendance-link:hover {
      color: #1d4ed8;
    }
    .absent-row td {
      background: #fefce8;
      font-size: 0.85rem;
    }
    .summary-footer {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #374151;
    }

    /* kolum darjah lebih sempit */
    .darjah-col {
      width: 70px;
      text-align: center;
      white-space: nowrap;
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 10px;
    }
    @media (max-width: 640px) {
      .header-text h1 {
        font-size: 1.15rem;
      }
      .students-header, .student-row {
        grid-template-columns: 42px 1fr 80px;
      }
      .students-container {
        max-height: 360px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-main">
      <div class="header-logo">
        <!-- Logo SKSA terkini -->
        <img src="https://i.imgur.com/AfsVtVG.png" alt="Logo SKSA" />
      </div>
      <div class="header-text">
        <h1>Rekod Kehadiran Harian Murid SKSA (Tahap 1)</h1>
        <p>Guru hanya perlu tandakan murid <strong>tidak hadir</strong>. Sistem akan kira kehadiran automatik untuk hari tersebut.</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-header">
        <h2>
          üìö Rekod Kehadiran
          <span class="badge">Tahap 1 (2025)</span>
        </h2>
        <div class="date-display" id="todayDisplay">Tarikh:</div>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="byClass">Rekod Mengikut Kelas</button>
        <button class="tab-btn" data-tab="summary">Ringkasan Semua Kelas</button>
      </div>

      <!-- TAB 1: Rekod mengikut kelas -->
      <div id="tab-byClass" class="tab-panel" style="display:block;">
        <div>
          <label for="classSelect">Pilih kelas:</label>
          <select id="classSelect">
            <option value="">‚Äî Sila pilih kelas ‚Äî</option>
          </select>
        </div>

        <div class="flex-row">
          <div class="pill">
            üîÅ <strong>Setiap hari baharu</strong> &nbsp;‚Äì kehadiran bermula semula (semua murid dianggap hadir).
          </div>
          <div>
            <button type="button" class="btn btn-outline" id="btnAllPresent">
              ‚úÖ Semua hadir
            </button>
            <button type="button" class="btn btn-outline" id="btnClearTicks">
              ‚úñ Reset tanda
            </button>
          </div>
        </div>

        <div id="studentsSection" style="margin-top: 16px; display: none;">

          <!-- carian nama murid -->
          <div class="search-row">
            <label for="searchInput">Carian nama murid:</label>
            <input
              type="text"
              id="searchInput"
              placeholder='Taip nama atau sebahagian nama, contoh: "adra"'
            />
          </div>

          <div class="students-container">
            <div class="students-header">
              <div>No.</div>
              <div>Nama Murid</div>
              <div style="text-align:center;">Tidak hadir</div>
            </div>
            <div id="studentsList"></div>
          </div>

          <div class="flex-row">
            <div class="pill" id="countInfo">
              üë• Jumlah murid: <strong>0</strong>
            </div>
            <button type="button" class="btn btn-primary" id="btnSave">
              <span class="btn-icon">üíæ</span>
              Simpan kehadiran hari ini
            </button>
          </div>

          <div class="summary-box" id="summaryBox" style="display:none;">
            <div class="summary-main">
              <div>
                <strong id="summaryTitle">Kehadiran hari ini:</strong>
                <div id="summaryRatio">0/0 hadir</div>
              </div>
              <div id="summaryMini"></div>
            </div>
            <div class="summary-absent" id="summaryAbsent"></div>
          </div>

          <div class="status-bar" id="statusBar"></div>
        </div>
      </div>

      <!-- TAB 2: Ringkasan semua kelas -->
      <div id="tab-summary" class="tab-panel" style="display:none;">

        <!-- Sub-tab Harian / Mingguan / Bulanan -->
        <div class="subtabs">
          <button class="subtab-btn active" data-subtab="daily">Harian</button>
          <button class="subtab-btn" data-subtab="weekly">Mingguan</button>
          <button class="subtab-btn" data-subtab="monthly">Bulanan</button>
        </div>

        <!-- Panel HARIAN (default) -->
        <div id="summaryDailyPanel" class="subtab-panel" style="display:block;">
          <div class="summary-header-row">
            Rekod Kehadiran Pada <span id="summaryDateLink" class="summary-date-link"></span>
          </div>

          <div class="summary-table-wrapper">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Bil</th>
                  <th class="darjah-col">Darjah</th>
                  <th>Kelas</th>
                  <th>Kehadiran</th>
                </tr>
              </thead>
              <tbody id="summaryTableBody">
                <!-- Diisi melalui JS -->
              </tbody>
            </table>
          </div>

          <div class="summary-footer" id="summaryFooter">
            Kehadiran : Tiada rekod kehadiran<br />
            Peratus Kehadiran : Tiada rekod kehadiran
          </div>
        </div>

        <!-- Panel MINGGUAN -->
        <div id="summaryWeeklyPanel" class="subtab-panel" style="display:none;">
          <div class="summary-header-row">
            Ringkasan Mingguan: <span id="weeklyRangeLabel"></span>
          </div>

          <div class="summary-table-wrapper">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Bil</th>
                  <th>Tarikh</th>
                  <th>Kehadiran</th>
                  <th>Peratus</th>
                </tr>
              </thead>
              <tbody id="weeklyTableBody">
                <!-- Diisi melalui JS -->
              </tbody>
            </table>
          </div>

          <div class="summary-footer" id="weeklyInfo">
            Tiada rekod kehadiran untuk minggu ini.
          </div>
        </div>

        <!-- Panel BULANAN -->
        <div id="summaryMonthlyPanel" class="subtab-panel" style="display:none;">
          <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
            <span>Ringkasan Bulanan: <span id="monthlyLabel"></span></span>
            <button type="button" class="btn btn-outline" id="btnPrintMonthly">
              üñ® Cetak
            </button>
          </div>

          <div class="summary-table-wrapper">
            <table class="summary-table">
              <thead>
                <tr>
                  <th>Bil</th>
                  <th>Tarikh</th>
                  <th>Kehadiran</th>
                  <th>Peratus</th>
                </tr>
              </thead>
              <tbody id="monthlyTableBody">
                <!-- Diisi melalui JS -->
              </tbody>
            </table>
          </div>

          <div class="summary-footer" id="monthlyInfo">
            Tiada rekod kehadiran untuk bulan ini.
          </div>
        </div>
      </div>
    </section>

    <footer>
      SK Sri Aman ¬∑ Modul Kehadiran Harian Tahap 1 (Firebase Realtime Database)
    </footer>
  </main>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
  (function () {
    'use strict';

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDbCgDz2vK2BZUpwM3iDWJcPQSptVcNkv4",
      authDomain: "kehadiran-murid-6ece0.firebaseapp.com",
      databaseURL: "https://kehadiran-murid-6ece0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "kehadiran-murid-6ece0",
      storageBucket: "kehadiran-murid-6ece0.firebasestorage.app",
      messagingSenderId: "223849234784",
      appId: "1:223849234784:web:e1471ded7ea17ba60bde05",
      measurementId: "G-4DY138HKTW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MONTH_NAMES_MS = [
      "Januari","Februari","Mac","April","Mei","Jun",
      "Julai","Ogos","September","Oktober","November","Disember"
    ];

    function formatDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return year + "-" + month + "-" + day;
    }

    function formatHumanDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const monthIndex = date.getMonth();
      const year = date.getFullYear();
      return day + " " + MONTH_NAMES_MS[monthIndex] + " " + year;
    }

    function getTodayKey() {
      return formatDateKey(new Date());
    }

    function getTodayHumanReadable() {
      return formatHumanDate(new Date());
    }

    // DATA NAMA MURID (ikut kelas)
    const classData = {
      "1B": [
        "AHMAD ZARIF MIKAEL BIN AHMAD ZULFIKA",
        "ALISHA HUMAIRA BINTI ZAINOOR ARIFFIN",
        "AMINAH BINTI MOHAMMAD SYAUQI",
        "ANGGUN ISABELLA BINTI MOHD HAFIZUL",
        "MOHAMMAD IMAN IKHSAN BIN ABDUL AZIZ",
        "MUHAMMAD AL-FATEH BIN ZULKIFLI",
        "MUHAMMAD EDRUS BIN MUHAMMAD RAFIQ DAS",
        "MUHAMMAD HARRAZ AL HAKIM BIN ABDUL FARIZUL HELMI",
        "MUHAMMAD HAZIQ BIN MOHD HELMI",
        "MUHAMMAD NAFIS BIN MOHAMED ABDULLAH",
        "MUHAMMAD RIZQ HAFIZH BIN MUHAMMAD HARITH",
        "MUHAMMAD UWAIS FARRELL BIN MOHAMAD FIRDAUS IZZAT",
        "MUHAMMAD ZAYDEAN HEDZRA BIN ZAINUDIN",
        "MUHAMMAD ZAYYAN ISKANDAR BIN ZULHAFIZ",
        "NAYL NADHIRAH BINTI NASHRU ISMAIL",
        "NUR ALISHZA ARIANA BINTI MOHD KHAIRUL HAKIM",
        "NUR ANNA BELLA BINTI HELMI",
        "NUR ARRISHA QHAIDINA BINTI MOHD AZMI",
        "NUR AURORA REZALEA BINTI MUHAMMAD AKMAL",
        "NUR HUMAIRA ELLISYA BINTI ABDURRAHMAN AL FATAH",
        "NUR IZZ SOFEA BINTI MUSLIM",
        "NUR MAIRAA DAMIA BINTI ZAINOL AZAM",
        "NUR SHAZWIN EQPILLA BINTI SHAHRIL NIZAM",
        "RAIN ARJUNA BIN WAN MUHAMAD HARIZ",
        "RAYYAN MIKAIL BIN MOHAMAD AZMEEN",
        "UMMU AISYAH BINTI MOHAMAD HAZAM"
      ],
      "1C": [
        "AHMAD ADAM UWAIS BIN MUHAMMAD FAIZ",
        "AMMAR DANISH BIN KAMARUL ISLAM",
        "DANIYAL HADIF BIN AHMAD BADZLY",
        "MUHAMMAD AKMAL ARIQ BIN MOHAMAD HUSNI",
        "MUHAMMAD AIRIL HIDAYAT BIN AHMAD BAKRI",
        "MUHAMMAD ARYAN RAYYAN BIN ZULKARNAEN",
        "MUHAMMAD DANIAQIL AQASY BIN MOHD SHAHRIL NIZAM",
        "MUHAMMAD FARID IRFAN BIN ABDUL RAZAK",
        "MUHAMMAD HASIF BIN FAIZAN",
        "MUHAMMAD HAZIQ RAHMAT BIN MOHD MUZAFAR",
        "MUHAMMAD IZQY RAFIQ BIN MOHD AZEEZ",
        "MUHAMMAD RIFQI IMRAN BIN MOHD ARIF",
        "MUHAMMAD THARIQ AFNAN BIN MAZLAN",
        "NAUFAL AQIL BIN MUHAMMAD ARIFFIN",
        "NOR SYAZWI AQIF BIN NOR SHAHROL AZMIZAM",
        "NUFAYYADH BIN MUHAMAD HAFIZ ZUHAR",
        "RAID AFZAL BIN MUHAMAD SYUKRI",
        "SHAHMI ILHAN BIN HAIRUL",
        "ADELIA QASEH DAMIA BINTI ROHAIZAD",
        "ALICIA BALQIS ILYANA BINTI JAMIL",
        "ALIA FARZANNA BINTI AZIZ",
        "ARDILLA ATHARAH BINTI RIDZUAN",
        "AUNI FALISHA BINTI MOHARIZMI",
        "MONICA RUJANAMI",
        "NUR ADRA NORAISHA BINTI ROSMAN",
        "NUR IZZ ZATIL FAREESHA BINTI MOHD AZHAR",
        "RAYSHA ATHIRAH BINTI MOHD ARIF",
        "WAN NUR AINUL MARDHIAH BINTI WAN FAKEH ALI"
      ],
      "1G": [
        "AIDAN RIZQI BIN AHMAD AIMULLAH",
        "AYRA ELIZA BINTI WAN ZAINAL ABIDIN",
        "MUHAMMAD AQIL AZFHA BIN AZLEY",
        "MUHAMMAD ARHUM RAYYAN BIN AZMAN",
        "MUHAMMAD DAUD BIN ZULKIFLI YAAKOP",
        "MUHAMMAD DAZAIF BIN MOHAMAD ROZALI",
        "MUHAMMAD IZZ HADIF BIN AZMAN HASHIM",
        "MUHAMMAD NAZMI HAKEEM BIN BAHAROL ANUAR",
        "MUHAMMAD RAYYAN DANISH BIN MOHD MISKON",
        "NUR FAIZA QISTINA BINTI AZLAN",
        "NUR FALLIZA ADANIA BINTI RIDZUAN",
        "NUR HANIS QASEH BINTI MOHAMAD RAZIF",
        "NUR IRDINA QAYYIM BINTI IZWAN",
        "NUR NAJIHAH BINTI AZAHAR",
        "NUR SAYYIDAH AISYAH BINTI KHAIRUL ANWAR",
        "NUR SUHAIRA SITI AISHAH BINTI RUHAIZIAN",
        "NUR SURAYA AIN BIN HARIDZUL IZWAN",
        "NUR WAFA' AS SAKINAH BINTI MOHD ZULHAIZAL",
        "QARISYA NUR ELMA BEYLYNA BINTI SHAHRIL SHAHMI",
        "NUR RAISHA BINTI MOHD TAKIUDDIN",
        "THAQIF ARJUNA BIN HAPANDI"
      ],
      "2B": [
        "AHMAD NAZRI NUFAIL BIN NIZAM",
        "AURIS MIKAEL BIN AHMAD SHAFIIN",
        "DANIAL RAYYAN BIN RIZAL",
        "DANISH ZAQWAN BIN MOHD HADZREEN",
        "JORDAN BIN BURHAN SHAMIL",
        "MUHAMMAD AHMAD NUFAYL BIN RIDZUAN",
        "MUHAMMAD ARIQ DAMIA BIN MOHD NOR",
        "MUHAMMAD ASYRAF HAZIQ BIN ZULKIFLI",
        "MUHAMMAD DANIAL AIMAN BIN ZABIDI",
        "MUHAMMAD FAWWAZ AQIL BIN FADZIL",
        "MUHAMMAD IZZ ISKANDAR BIN MOHD ZULHAZWAN",
        "MUHAMMAD NAZMI BIN ABDUL RAZAK",
        "MUHAMMAD RAYYAN ARYAN BIN RAZMAN",
        "MUHAMMAD RAZIN ZAQWAN BIN ZULZAFRAN",
        "NUH ZAYYAN BIN MUHAMMAD AFIZ",
        "ADLINA HANISHA MUHAMAD ARIFIN",
        "ALIA AQILAH BINTI ABDULLAH",
        "AMIRA ZARQAH BINTI AZMAN",
        "FARAH HAZIRAH BINTI MOHD IRZAM",
        "HANA ILISA NADZIRAH BINTI SYAZWAN SHUKOR",
        "IREEN SOFIA BINTI HELMI",
        "NUR AISYAH DANIA BINTI AHMAD ZIKRI",
        "NUR ARCILLA SYFA BINTI MUHAMAD IZHAM",
        "NUR ARISYA DAMIA SYAZWANI BINTI ABDULLAH",
        "NUR HANIS MARDIYAH BINTI MOHD HAFIZ",
        "SABRENA MARRY NAIDU"
      ],
      "2C": [
        "AFIQ NAUFAL BIN AZRIN",
        "AQIL RAYYAN BIN JAMALUDDIN",
        "DANIAL RAYYAN BIN MOHD ZAHRIN",
        "HARITH DANISH BIN MOHD HALIM",
        "MOHAMMAD AHMAD FAREES BIN MUHAMMAD SHAHMI",
        "MOHAMMAD IQFI HAZMAN BIN MOHD HAZMAN",
        "MUHAMMAD AFIQ HAZIM BIN MOHD ZAFRE",
        "MUHAMMAD ARYAN BIN SHAHRUL AFFENDY",
        "MUHAMMAD DANISH HAZIQ BIN FAIRUS",
        "MUHAMMAD HAZIQ HAKIM BIN AZHAR",
        "MUHAMMAD IKMAL BIN MOHD FARIDZUL",
        "MUHAMMAD RAIHAN ADZMAN BIN ROHAIZAD",
        "MUHAMMAD RAYYAN DARWYSY BIN REDZUAN",
        "MUHAMMAD RIDHUAN BIN FAISAL",
        "NAUFAL HAZIQ BIN FAIZAL",
        "NUR AIMEE NAJLA BINTI AZLAN",
        "NUR ARYSA NARA BINTI HANIS KHAIRI",
        "NUR BALQIS SOFEA BINTI BURHAN SHAMIL",
        "NUR MALAIQA MADINAH BINTI MARZLAN",
        "NUR ZAHIRA BINTI MOHD HALIM",
        "NUR AUFA IZZATUNRISSA BINTI MOHARIZMI",
        "RAFIQ QUSYAIRI BIN RANDY",
        "WAFA SAFIYYAH BINTI SHUKOR",
        "WAFIYYAH HUMAIRA BINTI MUHAMAD NORASMAN"
      ],
      "2G": [
        "AFEA IRDINA BINTI MOHD YUSROL",
        "AHMAD ADAM ALIY BIN AMIR SHARIFUDIN",
        "ARWISH RIFQI BIN MOHD RADZIF",
        "DANIES KHALEL BIN MOHAMAD ZAKI",
        "MUHAMMAD ARYAN BIN HIZZADY",
        "MUHAMMAD AZHAN ARIEF BIN ABDUL RAZAK",
        "MUHAMMAD DANISH HAIQAL BIN MOHD SHAFIQ",
        "MUHAMMAD DARWISY BIN KHAIRUN NAZARI",
        "MUHAMMAD HARITH BIN NOR IZHAM",
        "MUHAMMAD RAZIM ADHA BIN AZMAN",
        "MUHD NAUFAL AUFA BIN AZRIN",
        "NAUFAL IRFAN BIN MOHD FADLILAH",
        "NIZAR MUHAIMIN BIN MOHAMAD NAJIB",
        "NUR AQILAH QISTINA BINTI MOHD RAZMAN",
        "NUR ARISHA AFIFAH BINTI AKHMAZUL HELMI",
        "NUR AUNI ARISSA BINTI MOHD AZRIN",
        "NUR FATHIN AFRINA BINTI NASHZULHAKIM",
        "NUR HANA ELLEYA BINTI SHAKIRIN",
        "NUR IZZATI ASIFAH BINTI ROHAIZAT",
        "NURIZZAH HAKIMAH BINTI MOHD YUSRI",
        "PUTRI ADRIANA BINTI ROSDI",
        "RANIA ALEESYA QAISARA BINTI MAZLAN",
        "SABRINAH ANASTASIA BINTI JOSEPH",
        "SYAFIYYAH ASYFIAH BINTI AZAMAN HARIS",
        "WANI NATASHA BINTI ZULKIFLI",
        "ZERENEY SYAEEDAH BINTI MOHAMAD HUSAINI",
        "ZUYYIN NAQIYYA BINTI MOHD FAZLY"
      ],
      "3B": [
        "AMMAR AR RAIYAN BIN AZNAL",
        "FATHIMA MUNEERA BINTI ABDUL MUNAF",
        "MUHAMMAD AADAM IMRAN BIN MUHAMMAD FAREEZ",
        "MUHAMMAD AMAR AFIQ BIN ZURHAINIZAM",
        "MUHAMMAD ARTHUR FAYED BIN DZWIGOR",
        "MUHAMMAD ASHRAF DANISH BIN MOHD KAMAL",
        "MUHAMMAD EIDRIS BIN MOHD AZMI",
        "MUHAMMAD HAZIQ AHMAD BIN AHMAD AFIF",
        "MUHAMMAD NUR ZAYYAN BIN MOHD FIRDAUS",
        "MUHAMMAD RAAEI MIKAIL BIN RASID",
        "MUHAMMAD THAQIF MAISAL BIN MOHD FAHMI",
        "MUHAMMAD YUSUF BIN HIZAM",
        "MUHAMMAD ZACHARY BIN AJIS",
        "NUR SHARIFAH BATRISYIAH BINTI SUBRATA",
        "QHALEED AFZAN BIN ASWADI",
        "SHAHZAIN BIN HIZAM",
        "AMANI ADEEQA BINTI ABG MAHADI",
        "AYLA SIRAH BINTI MUHAMMAD SHAHRUL IZWAN",
        "FARAH DAMIA HUSNAA BINTI ADZWAN",
        "MOHAMAD NAZIHATUL HABIBAH BINTI TAQN ADDIN",
        "NABILA KHADIJAH BINTI MOHAMAD TAQIF",
        "NURUL ALISYA BINTI MOHD FITRI"
      ],
      "3C": [
        "ABU KHAISAMAH BIN AZIZUL",
        "MUHAMMAD ADIB LUTHFI BIN MUHAMAD YUSOF",
        "MUHAMMAD AMMAR BIN MOHD ARIFFIN",
        "MUHAMMAD IZZUL HADI BIN MOHD HAFAIZI",
        "MUHAMMAD RAFEEQ DANISH BIN ERWAN",
        "MUHAMMAD ZAQIY BIN MOHD NAJIB",
        "MUHD RAYYAN SYAKIR BIN HAFIZ",
        "NAUFAL ZIQRI ADLEY BIN MOHD FUHD BIN RASHID MEOR",
        "AQEELA MARISSA BINTI MARZUKI",
        "AQIDAH WISDAH BINTI MOHAMMAD ZAMRI",
        "FARISYA QHAIRUNNISA BINTI ABDUL RAZAK",
        "NIL CROSS REEF",
        "NUR AAISHA ARIQAH BINTI MOHAMMAD ZAIDI",
        "NUR AQILAH SOFEA BINTI AMIRUDDIN",
        "NUR ARWANI AQEELA BINTI HASNIN HARIDZHEN",
        "NUR ASMA MARIAM BINTI MOHD HAFIZ",
        "NUR BALQIS SHAQIRA BINTI ABDULLAH",
        "NURJIHAD DAMIA QHAISARA BINTI MOHAMAD FAUZI",
        "NUR MEYSARA HAZIEQA BINTI MOHAMMAD AL FARUQI",
        "NUR MAISARAH BINTI ABU BAKAR",
        "NUR NAJWA NAJIHIN BINTI ABDUL SANI",
        "NUR RANIA RIZQAA BINTI MOHD SAHIDAN",
        "NUR INARAH BINTI ABU BAKAR",
        "NUR QEISHA AZ-ZAHRA BINTI ZULKIFLI"
      ],
      "3G": [
        "AISYAH RANIA BINTI ABU BAKAR",
        "ALIA MAISARAH BINTI ROSCIDI",
        "ALIF ZAFWAN BIN AZHAR",
        "DANISH AIMAN BIN MOHD SHAFIQ",
        "HAZIQ DANIAL BIN FADZIL",
        "HILMY ADIFA BIN WAN MUHAMMAD FAIZULKHALID",
        "MUHAMMAD AIMAN HAZIQ BIN HAIKAL",
        "MUHAMMAD AMIR AIMAN BIN AZMI",
        "MUHAMMAD ARIF RAYYAN BIN MUHAMMAD HAFIZ",
        "MUHAMMAD DANIAL NAJMI BIN MOHD FIRDAUS",
        "MUHAMMAD FAREES BIN AZURRAZI",
        "MUHAMMAD IRFAN AKMAL BIN MOHD NAJIB",
        "MUHAMMAD NAUFAL FIQRI BIN FAIZUL",
        "MUHAMMAD RAYYAN HAZIM BIN HAFIZ",
        "SYAFIQ HAZIM BIN ROSDI",
        "AFIQAH DAMIA BINTI ABDULLAH",
        "AUNI ADRIANA BINTI MOHD FAIZUL",
        "AZAHARA SYIFA BINTI MUHAMMAD IMRAN",
        "FATIHAH ERYNA BINTI RIZAL",
        "NUR ADLINA BALQIS BINTI MOHAMAD ZAKI",
        "NUR ALEESYA DAMIA BINTI SHAHRUL ZAMAN",
        "NUR ANIS BINTI MOHAMAD SAHIDAN",
        "NUR AUNI MAISARAH BINTI MOHAMAD ZULKIFLI",
        "NUR IZZAH ISMIRA BINTI NIZAMUDIN",
        "NUR NAYLI QASEH BINTI MOHD HAFIZ",
        "NURUL ARISYA DAMIA BINTI ABDULLAH",
        "NURUL BALQIS MARDHIAH BINTI RUSHDAN",
        "NURUL HASYIMAH DAMIA BINTI MOHD RIDZUAN",
        "NURUL IZZAH DAMIA BINTI ABU HASSAN",
        "NUR QIRAH BINTI ABDULLAH",
        "NUR ARISHA SAFIYA BINTI MOHD AZLAN",
        "NUR DARWISYAH QAISARA BINTI MOHAMAD REDZUAN",
        "NUR ELMIRA AMANI BINTI MUHAMMAD SIDDIQ",
        "NUR WARDAH BINTI MOHD NOORADDLY",
        "SHAZMIA ELLYSYA BINTI SHAHRIL HAZRIE",
        "ZAYYAN AYDEN BIN MOHAMAD ZULHUSNI"
      ]
    };

    // mapping untuk ringkasan harian kelas
    const summaryConfig = [
      { darjah: "D1", kelasLabel: "BESTARI", code: "1B" },
      { darjah: "D1", kelasLabel: "CEMERLANG", code: "1C" },
      { darjah: "D1", kelasLabel: "GEMILANG", code: "1G" },
      { darjah: "D2", kelasLabel: "BESTARI", code: "2B" },
      { darjah: "D2", kelasLabel: "CEMERLANG", code: "2C" },
      { darjah: "D2", kelasLabel: "GEMILANG", code: "2G" },
      { darjah: "D3", kelasLabel: "BESTARI", code: "3B" },
      { darjah: "D3", kelasLabel: "CEMERLANG", code: "3C" },
      { darjah: "D3", kelasLabel: "GEMILANG", code: "3G" }
    ];

    // DOM refs
    const classSelect = document.getElementById('classSelect');
    const studentsSection = document.getElementById('studentsSection');
    const studentsList = document.getElementById('studentsList');
    const countInfo = document.getElementById('countInfo');
    const btnAllPresent = document.getElementById('btnAllPresent');
    const btnClearTicks = document.getElementById('btnClearTicks');
    const btnSave = document.getElementById('btnSave');
    const summaryBox = document.getElementById('summaryBox');
    const summaryRatio = document.getElementById('summaryRatio');
    const summaryMini = document.getElementById('summaryMini');
    const summaryAbsent = document.getElementById('summaryAbsent');
    const statusBar = document.getElementById('statusBar');
    const todayDisplay = document.getElementById('todayDisplay');
    const searchInput = document.getElementById('searchInput');

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanelByClass = document.getElementById('tab-byClass');
    const tabPanelSummary = document.getElementById('tab-summary');
    const summaryDateLink = document.getElementById('summaryDateLink');
    const summaryTableBody = document.getElementById('summaryTableBody');
    const summaryFooter = document.getElementById('summaryFooter');

    // sub-tab ringkasan
    const subtabButtons = document.querySelectorAll('.subtab-btn');
    const dailyPanel = document.getElementById('summaryDailyPanel');
    const weeklyPanel = document.getElementById('summaryWeeklyPanel');
    const monthlyPanel = document.getElementById('summaryMonthlyPanel');

    const weeklyRangeLabel = document.getElementById('weeklyRangeLabel');
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const weeklyInfo = document.getElementById('weeklyInfo');

    const monthlyLabel = document.getElementById('monthlyLabel');
    const monthlyTableBody = document.getElementById('monthlyTableBody');
    const monthlyInfo = document.getElementById('monthlyInfo');
    const btnPrintMonthly = document.getElementById('btnPrintMonthly');

    const todayHuman = getTodayHumanReadable();
    todayDisplay.textContent = 'Tarikh: ' + todayHuman;
    summaryDateLink.textContent = todayHuman;

    // TABS utama
    tabButtons.forEach(function(btn){
      btn.addEventListener('click', function(){
        tabButtons.forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        if (target === 'byClass') {
          tabPanelByClass.style.display = 'block';
          tabPanelSummary.style.display = 'none';
        } else {
          tabPanelByClass.style.display = 'none';
          tabPanelSummary.style.display = 'block';
          activateSubtab('daily'); // default bila buka Ringkasan Semua Kelas
        }
      });
    });

    // Sub-tab Ringkasan (harian/mingguan/bulanan)
    function activateSubtab(name) {
      subtabButtons.forEach(function(b){
        if (b.getAttribute('data-subtab') === name) {
          b.classList.add('active');
        } else {
          b.classList.remove('active');
        }
      });

      dailyPanel.style.display = (name === 'daily') ? 'block' : 'none';
      weeklyPanel.style.display = (name === 'weekly') ? 'block' : 'none';
      monthlyPanel.style.display = (name === 'monthly') ? 'block' : 'none';

      if (name === 'daily') {
        loadSummaryTable();
      } else if (name === 'weekly') {
        loadWeeklySummary();
      } else if (name === 'monthly') {
        loadMonthlySummary();
      }
    }

    subtabButtons.forEach(function(btn){
      btn.addEventListener('click', function(){
        activateSubtab(btn.getAttribute('data-subtab'));
      });
    });

    if (btnPrintMonthly) {
      btnPrintMonthly.addEventListener('click', function () {
        window.print();
      });
    }

    // isi dropdown kelas
    function populateClassDropdown() {
      Object.keys(classData).sort().forEach(function(kelas){
        const opt = document.createElement('option');
        opt.value = kelas;
        opt.textContent = kelas;
        classSelect.appendChild(opt);
      });
    }
    populateClassDropdown();

    function setStatus(msg, type) {
      statusBar.innerHTML = '';
      const span = document.createElement('span');
      span.className = 'status-pill';
      if (type === 'error') span.classList.add('error');
      if (type === 'info') span.classList.add('info');
      span.textContent = msg;
      statusBar.appendChild(span);
    }

    function updateSummaryUI(kelas, total, present, absentees) {
      summaryBox.style.display = 'block';
      summaryRatio.textContent = present + '/' + total + ' hadir';
      summaryMini.textContent = 'Kelas ' + kelas + ' ¬∑ ' + getTodayHumanReadable();

      if (!absentees || absentees.length === 0) {
        summaryAbsent.innerHTML = '<strong>Tidak hadir:</strong> Tiada. Semua murid hadir hari ini. üéâ';
      } else {
        const parts = absentees.map(function(n, i){ return (i+1) + ') ' + n; });
        summaryAbsent.innerHTML = '<strong>Tidak hadir:</strong> ' + parts.join(' ¬∑ ');
      }
    }

    function handleSearch() {
      if (!searchInput) return;
      const q = searchInput.value.trim().toLowerCase();
      const rows = document.querySelectorAll('#studentsList .student-row');
      rows.forEach(function(row){
        const nameLower = row.getAttribute('data-namelower') || '';
        row.style.display = (!q || nameLower.indexOf(q) !== -1) ? 'grid' : 'none';
      });
    }
    if (searchInput) {
      searchInput.addEventListener('input', handleSearch);
    }

    function renderStudentsForClass(kelas) {
      studentsList.innerHTML = '';
      summaryBox.style.display = 'none';
      statusBar.innerHTML = '';

      if (!kelas || !classData[kelas] || classData[kelas].length === 0) {
        studentsSection.style.display = 'none';
        return;
      }

      const names = classData[kelas];

      names.forEach(function(nama, index){
        const row = document.createElement('div');
        row.className = 'student-row';
        row.setAttribute('data-namelower', nama.toLowerCase());

        const colNo = document.createElement('div');
        colNo.textContent = index + 1;

        const colName = document.createElement('div');
        colName.className = 'student-name';
        colName.textContent = nama;

        const colChk = document.createElement('div');
        colChk.className = 'checkbox-wrapper';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'student-checkbox';
        cb.setAttribute('data-name', nama);
        colChk.appendChild(cb);

        row.appendChild(colNo);
        row.appendChild(colName);
        row.appendChild(colChk);
        studentsList.appendChild(row);
      });

      studentsSection.style.display = 'block';
      countInfo.innerHTML = 'üë• Jumlah murid: <strong>' + names.length + '</strong>';

      if (searchInput) searchInput.value = '';
      handleSearch();

      const todayKey = getTodayKey();
      const year = new Date().getFullYear();
      const path = 'kehadiran/' + year + '/' + kelas + '/' + todayKey;

      db.ref(path).once('value').then(function(snap){
        const data = snap.val();
        if (data && Array.isArray(data.absentees)) {
          const abs = data.absentees;
          document.querySelectorAll('.student-checkbox').forEach(function(cb){
            cb.checked = abs.indexOf(cb.getAttribute('data-name')) !== -1;
          });
          updateSummaryUI(kelas, names.length, names.length - abs.length, abs);
          setStatus('Data kehadiran hari ini telah direkod sebelum ini. Anda boleh kemaskini semula dan simpan.', 'info');
        } else {
          setStatus('Semua murid ditanda hadir secara default. Tanda sahaja murid yang tidak hadir.', 'info');
        }
      });
    }

    classSelect.addEventListener('change', function(){
      const kelas = classSelect.value;
      if (!kelas) {
        studentsSection.style.display = 'none';
        return;
      }
      renderStudentsForClass(kelas);
    });

    btnAllPresent.addEventListener('click', function(){
      document.querySelectorAll('.student-checkbox').forEach(function(cb){ cb.checked = false; });
      setStatus('Semua murid ditanda hadir.', 'success');
    });

    btnClearTicks.addEventListener('click', function(){
      document.querySelectorAll('.student-checkbox').forEach(function(cb){ cb.checked = false; });
      summaryBox.style.display = 'none';
      setStatus('Semua tanda tidak hadir telah di-reset.', 'info');
    });

    btnSave.addEventListener('click', function(){
      const kelas = classSelect.value;
      if (!kelas) {
        setStatus('Sila pilih kelas dahulu.', 'error');
        alert('Sila pilih kelas dahulu.');
        return;
      }

      const names = classData[kelas] || [];
      const total = names.length;
      const abs = [];
      document.querySelectorAll('.student-checkbox').forEach(function(cb){
        if (cb.checked) abs.push(cb.getAttribute('data-name'));
      });
      const present = total - abs.length;

      const todayKey = getTodayKey();
      const year = new Date().getFullYear();
      const path = 'kehadiran/' + year + '/' + kelas + '/' + todayKey';

      const studentStatus = {};
      names.forEach(function(nama){
        studentStatus[nama] = abs.indexOf(nama) === -1;
      });

      const data = {
        class: kelas,
        dateKey: todayKey,
        humanDate: getTodayHumanReadable(),
        totalStudents: total,
        presentCount: present,
        absentCount: abs.length,
        absentees: abs,
        studentStatus: studentStatus,
        savedAt: new Date().toISOString()
      };

      db.ref(path).set(data).then(function(){
        updateSummaryUI(kelas, total, present, abs);
        setStatus('Kehadiran hari ini berjaya disimpan ke dalam Firebase.', 'success');
      }).catch(function(err){
        console.error(err);
        setStatus('Ralat semasa menyimpan kehadiran. Sila cuba lagi.', 'error');
        alert('Ralat semasa menyimpan kehadiran: ' + err.message);
      });
    });

    // --------- RINGKASAN HARIAN (mengikut kelas) -----------
    function loadSummaryTable() {
      const todayKey = getTodayKey();
      const year = new Date().getFullYear();

      summaryTableBody.innerHTML =
        '<tr><td colspan="4" class="main-row-cell" style="text-align:center; padding:8px; font-size:0.9rem;">Memuatkan rekod kehadiran...</td></tr>';

      let totalPresent = 0;
      let totalStudents = 0;
      let anyRecord = false;

      const promises = summaryConfig.map(function(item, idx){
        const path = 'kehadiran/' + year + '/' + item.code + '/' + todayKey;
        return db.ref(path).once('value').then(function(snap){
          const d = snap.val();
          let text, notUpdated = false, abs = [];
          if (d && typeof d.presentCount === 'number' && typeof d.totalStudents === 'number') {
            text = d.presentCount + '/' + d.totalStudents;
            totalPresent += d.presentCount;
            totalStudents += d.totalStudents;
            anyRecord = true;
            if (Array.isArray(d.absentees)) abs = d.absentees;
          } else {
            text = 'Kehadiran Belum Dikemaskini.';
            notUpdated = true;
          }
          return {
            bil: idx + 1,
            darjah: item.darjah,
            kelasLabel: item.kelasLabel,
            text: text,
            notUpdated: notUpdated,
            absentees: abs
          };
        });
      });

      Promise.all(promises).then(function(rows){
        summaryTableBody.innerHTML = '';

        rows.forEach(function(row){
          const tr = document.createElement('tr');
          if (row.notUpdated) tr.classList.add('row-not-updated');

          const td1 = document.createElement('td');
          td1.className = 'main-row-cell';
          td1.textContent = row.bil;

          const td2 = document.createElement('td');
          td2.className = 'main-row-cell darjah-col';
          td2.textContent = row.darjah;

          const td3 = document.createElement('td');
          td3.className = 'main-row-cell';
          td3.textContent = row.kelasLabel;

          const td4 = document.createElement('td');
          td4.className = 'main-row-cell';

          if (row.notUpdated) {
            td4.textContent = row.text;
            td4.classList.add('cell-not-updated');
          } else {
            const span = document.createElement('span');
            span.className = 'attendance-link';
            span.textContent = row.text;
            td4.appendChild(span);
          }

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          summaryTableBody.appendChild(tr);

          if (!row.notUpdated) {
            const trDetail = document.createElement('tr');
            trDetail.className = 'absent-row';
            trDetail.style.display = 'none';

            const tdDetail = document.createElement('td');
            tdDetail.colSpan = 4;

            if (!row.absentees || row.absentees.length === 0) {
              tdDetail.textContent = 'Tidak hadir: Tiada. Semua murid hadir untuk kelas ini.';
            } else {
              const label = document.createElement('div');
              label.innerHTML = '<strong>Tidak hadir:</strong>';
              const ul = document.createElement('ul');
              row.absentees.forEach(function(nama, i){
                const li = document.createElement('li');
                li.textContent = (i+1) + ') ' + nama;
                ul.appendChild(li);
              });
              tdDetail.appendChild(label);
              tdDetail.appendChild(ul);
            }

            trDetail.appendChild(tdDetail);
            summaryTableBody.appendChild(trDetail);

            const link = td4.querySelector('.attendance-link');
            link.addEventListener('click', function(){
              trDetail.style.display = (trDetail.style.display === 'none') ? 'table-row' : 'none';
            });
          }
        });

        if (!anyRecord) {
          summaryFooter.innerHTML =
            'Kehadiran : Tiada rekod kehadiran<br>Peratus Kehadiran : Tiada rekod kehadiran';
        } else {
          const percent = totalStudents > 0 ? ((totalPresent / totalStudents) * 100).toFixed(1) : 0;
          summaryFooter.innerHTML =
            'Kehadiran : ' + totalPresent + '/' + totalStudents +
            '<br>Peratus Kehadiran : ' + percent + '%';
        }
      }).catch(function(err){
        console.error(err);
        summaryTableBody.innerHTML =
          '<tr><td colspan="4" class="main-row-cell" style="text-align:center; padding:8px; font-size:0.9rem; color:#b91c1c;">Ralat memuatkan rekod kehadiran.</td></tr>';
        summaryFooter.innerHTML =
          'Kehadiran : Tiada rekod kehadiran<br>Peratus Kehadiran : Tiada rekod kehadiran';
      });
    }

    // ---------- RINGKASAN MINGGUAN ----------
    function loadWeeklySummary() {
      const today = new Date();
      const year = today.getFullYear();

      // cari hari Isnin untuk minggu ini
      const jsDay = today.getDay(); // 0=Ahad
      const offsetToMonday = (jsDay + 6) % 7;
      const start = new Date(today);
      start.setDate(today.getDate() - offsetToMonday);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);

      weeklyRangeLabel.textContent =
        formatHumanDate(start) + " - " + formatHumanDate(end);

      weeklyTableBody.innerHTML =
        '<tr><td colspan="4" style="text-align:center; padding:8px; font-size:0.9rem;">Memuatkan rekod mingguan...</td></tr>';

      const dates = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        dates.push(new Date(d));
      }

      const perDayPromises = dates.map(function(date, idx){
        const dateKey = formatDateKey(date);
        let totalPresent = 0;
        let totalStudents = 0;
        let any = false;

        const classPromises = summaryConfig.map(function(item){
          const path = 'kehadiran/' + year + '/' + item.code + '/' + dateKey;
          return db.ref(path).once('value').then(function(snap){
            const data = snap.val();
            if (data && typeof data.presentCount === 'number' && typeof data.totalStudents === 'number') {
              totalPresent += data.presentCount;
              totalStudents += data.totalStudents;
              any = true;
            }
          });
        });

        return Promise.all(classPromises).then(function(){
          return {
            index: idx + 1,
            date: new Date(date),
            totalPresent: totalPresent,
            totalStudents: totalStudents,
            any: any
          };
        });
      });

      Promise.all(perDayPromises).then(function(rows){
        weeklyTableBody.innerHTML = '';
        let grandPresent = 0;
        let grandTotal = 0;
        let anyRecord = false;

        rows.forEach(function(row){
          const tr = document.createElement('tr');

          const td1 = document.createElement('td');
          td1.textContent = row.index;

          const td2 = document.createElement('td');
          td2.textContent = formatHumanDate(row.date);

          const td3 = document.createElement('td');
          const td4 = document.createElement('td');

          if (!row.any || row.totalStudents === 0) {
            td3.textContent = 'Tiada rekod';
            td4.textContent = '-';
          } else {
            anyRecord = true;
            grandPresent += row.totalPresent;
            grandTotal += row.totalStudents;
            const pct = ((row.totalPresent / row.totalStudents) * 100).toFixed(1);
            td3.textContent = row.totalPresent + '/' + row.totalStudents;
            td4.textContent = pct + '%';
          }

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          weeklyTableBody.appendChild(tr);
        });

        if (!anyRecord) {
          weeklyInfo.textContent = 'Tiada rekod kehadiran untuk minggu ini.';
        } else {
          const pct = grandTotal > 0 ? ((grandPresent / grandTotal) * 100).toFixed(1) : 0;
          weeklyInfo.textContent =
            'Jumlah keseluruhan minggu ini: ' +
            grandPresent + '/' + grandTotal + ' (' + pct + '%).';
        }
      }).catch(function(err){
        console.error(err);
        weeklyTableBody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; padding:8px; font-size:0.9rem; color:#b91c1c;">Ralat memuatkan rekod mingguan.</td></tr>';
        weeklyInfo.textContent = 'Tiada rekod kehadiran untuk minggu ini.';
      });
    }

    // ---------- RINGKASAN BULANAN ----------
    function loadMonthlySummary() {
      const today = new Date();
      const year = today.getFullYear();
      const monthIndex = today.getMonth();

      const firstDay = new Date(year, monthIndex, 1);
      const lastDay = new Date(year, monthIndex + 1, 0);

      monthlyLabel.textContent =
        MONTH_NAMES_MS[monthIndex] + " " + year;

      monthlyTableBody.innerHTML =
        '<tr><td colspan="4" style="text-align:center; padding:8px; font-size:0.9rem;">Memuatkan rekod bulanan...</td></tr>';

      const dates = [];
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        dates.push(new Date(d));
      }

      const perDayPromises = dates.map(function(date, idx){
        const dateKey = formatDateKey(date);
        let totalPresent = 0;
        let totalStudents = 0;
        let any = false;

        const classPromises = summaryConfig.map(function(item){
          const path = 'kehadiran/' + year + '/' + item.code + '/' + dateKey;
          return db.ref(path).once('value').then(function(snap){
            const data = snap.val();
            if (data && typeof data.presentCount === 'number' && typeof data.totalStudents === 'number') {
              totalPresent += data.presentCount;
              totalStudents += data.totalStudents;
              any = true;
            }
          });
        });

        return Promise.all(classPromises).then(function(){
          return {
            index: idx + 1,
            date: new Date(date),
            totalPresent: totalPresent,
            totalStudents: totalStudents,
            any: any
          };
        });
      });

      Promise.all(perDayPromises).then(function(rows){
        monthlyTableBody.innerHTML = '';
        let grandPresent = 0;
        let grandTotal = 0;
        let anyRecord = false;

        rows.forEach(function(row){
          const tr = document.createElement('tr');

          const td1 = document.createElement('td');
          td1.textContent = row.index;

          const td2 = document.createElement('td');
          td2.textContent = formatHumanDate(row.date);

          const td3 = document.createElement('td');
          const td4 = document.createElement('td');

          if (!row.any || row.totalStudents === 0) {
            td3.textContent = 'Tiada rekod';
            td4.textContent = '-';
          } else {
            anyRecord = true;
            grandPresent += row.totalPresent;
            grandTotal += row.totalStudents;
            const pct = ((row.totalPresent / row.totalStudents) * 100).toFixed(1);
            td3.textContent = row.totalPresent + '/' + row.totalStudents;
            td4.textContent = pct + '%';
          }

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          monthlyTableBody.appendChild(tr);
        });

        if (!anyRecord) {
          monthlyInfo.textContent = 'Tiada rekod kehadiran untuk bulan ini.';
        } else {
          const pct = grandTotal > 0 ? ((grandPresent / grandTotal) * 100).toFixed(1) : 0;
          monthlyInfo.textContent =
            'Jumlah keseluruhan bulan ini: ' +
            grandPresent + '/' + grandTotal + ' (' + pct + '%).';
        }
      }).catch(function(err){
        console.error(err);
        monthlyTableBody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; padding:8px; font-size:0.9rem; color:#b91c1c;">Ralat memuatkan rekod bulanan.</td></tr>';
        monthlyInfo.textContent = 'Tiada rekod kehadiran untuk bulan ini.';
      });
    }

  })();
  </script>
</body>
</html>
