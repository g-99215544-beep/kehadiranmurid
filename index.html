<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Rekod Kehadiran Murid SKSA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Sistem Rekod Kehadiran Harian Murid SK Sri Aman">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kehadiran SKSA">
  
  <!-- App Icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    * { box-sizing: border-box; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body { margin: 0; padding: 0; background: #f3f4f6; color: #111827; }
    header { background: linear-gradient(135deg,#2563eb,#1d4ed8); color: #fff; padding: 12px 20px 14px; box-shadow: 0 2px 8px rgba(15,23,42,0.4); position: sticky; top: 0; z-index: 10; }
    .header-main { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .header-logo { height:48px; width:48px; border-radius:999px; background:#fff; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 6px rgba(0,0,0,.25); cursor:pointer; position:relative; }
    .header-logo img { max-width:100%; max-height:100%; display:block; border-radius:999px; }
    .notification-badge { position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; font-size:.7rem; min-width:20px; height:20px; padding:0 5px; border-radius:999px; display:none; align-items:center; justify-content:center; font-weight:700; box-shadow:0 0 0 3px #1d4ed8; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .header-text h1 { margin:0; font-size:1.4rem; font-weight:700; }
    .header-text p { margin:2px 0 0; font-size:.9rem; opacity:.9; }
    main { max-width:1040px; margin:20px auto; padding:0 16px 32px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 10px 25px rgba(15,23,42,.08); padding:20px; margin-bottom:20px; border:1px solid #e5e7eb; }
    .card-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .card-header h2 { margin:0; font-size:1.1rem; display:flex; align-items:center; gap:8px; }
    .badge { display:inline-block; padding:2px 10px; border-radius:999px; font-size:.75rem; background:#e0f2fe; color:#0369a1; font-weight:600; }
    .date-display { font-size:1.15rem; color:#111827; font-weight:600; }
    label { font-size:.9rem; color:#374151; }
    select, button { font-size:.9rem; }
    select { width:100%; padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; outline:none; background:#f9fafb; transition:border-color .15s, box-shadow .15s, background .15s; }
    select:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,.25); background:#fff; }
    .flex-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:12px; }
    .btn { border-radius:999px; border:none; padding:8px 16px; cursor:pointer; font-weight:600; display:inline-flex; align-items:center; gap:6px; box-shadow:0 8px 16px rgba(15,23,42,.18); transition:transform .1s, box-shadow .1s, background .1s; }
    .btn-primary { background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; }
    .btn-outline { background:#fff; color:#1f2937; border:1px solid #d1d5db; box-shadow:none; }
    .btn-secondary { background:#e5e7eb; color:#111827; box-shadow:none; }
    .btn-success { background:linear-gradient(135deg,#059669,#047857); color:#fff; }
    .btn-danger { background:linear-gradient(135deg,#dc2626,#b91c1c); color:#fff; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 12px 22px rgba(15,23,42,.18); }
    .btn:active { transform:translateY(0); box-shadow:0 6px 12px rgba(15,23,42,.18); }
    .btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
    .btn-sm { padding:4px 10px; font-size:.8rem; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:.8rem; color:#374151; }
    .pill strong { color:#111827; }
    .tabs { margin-top:4px; display:flex; flex-wrap:wrap; gap:6px; border-bottom:1px solid #e5e7eb; padding-bottom:4px; }
    .tab-btn { border:1px solid #e5e7eb; background:#f9fafb; padding:6px 14px; border-radius:999px; cursor:pointer; font-size:.9rem; color:#4b5563; transition:background .15s, color .15s, box-shadow .15s, border-color .15s; }
    .tab-btn:hover { background:#f3f4ff; }
    .tab-btn.active { background:#fff; color:#1d4ed8; font-weight:600; border-color:#bfdbfe; box-shadow:0 2px 6px rgba(15,23,42,.2); }
    .tab-panel { margin-top:12px; }
    .subtabs { margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .subtab-btn { border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; padding:4px 12px; font-size:.85rem; cursor:pointer; color:#4b5563; transition:background .15s, color .15s, box-shadow .15s, border-color .15s; }
    .subtab-btn:hover { background:#eef2ff; }
    .subtab-btn.active { background:#fff; color:#2563eb; font-weight:600; border-color:#bfdbfe; box-shadow:0 1px 4px rgba(15,23,42,.2); }
    .subtab-panel { margin-top:8px; }
    .search-row { margin-top:14px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; }
    .search-row label { font-size:.85rem; white-space:nowrap; }
    .search-row input[type="text"] { flex:1 1 220px; padding:8px 10px; border-radius:999px; border:1px solid #d1d5db; background:#f9fafb; font-size:.9rem; outline:none; transition:border-color .15s, box-shadow .15s, background .15s; }
    .search-row input[type="text"]:focus { border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,.25); background:#fff; }
    .students-container { margin-top:12px; max-height:420px; overflow-y:auto; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb; }
    .students-header { display:grid; grid-template-columns:52px 1fr 90px 100px; padding:8px 12px; border-bottom:1px solid #e5e7eb; font-size:.8rem; font-weight:600; color:#6b7280; background:#f3f4f6; position:sticky; top:0; z-index:2; }
    .student-row { display:grid; grid-template-columns:52px 1fr 90px 100px; padding:7px 12px; align-items:center; font-size:.9rem; border-bottom:1px solid #e5e7eb; background:#fff; }
    .student-row:nth-child(even) { background:#f9fafb; }
    .student-row:hover { background:#eff6ff; }
    .student-name { font-weight:500; color:#111827; }
    .checkbox-wrapper { display:flex; justify-content:center; }
    .checkbox-wrapper input { width:18px; height:18px; cursor:pointer; }
    .bersebab-wrapper { display:flex; align-items:center; justify-content:center; gap:4px; font-size:.75rem; color:#6b7280; }
    .bersebab-wrapper input { width:16px; height:16px; cursor:pointer; accent-color:#10b981; }
    .bersebab-wrapper.hidden { visibility:hidden; }
    .summary-box { margin-top:16px; padding:12px 14px; border-radius:12px; background:#eff6ff; border:1px solid #bfdbfe; font-size:.9rem; color:#1e3a8a; }
    .summary-main { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .summary-main strong { font-size:1rem; }
    .summary-absent { margin-top:8px; font-size:.9rem; }
    .summary-absent ul { margin:4px 0 0 18px; padding:0; }
    .summary-absent li { margin:0; }
    .status-bar { margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; font-size:.85rem; }
    .status-pill { padding:4px 10px; border-radius:999px; background:#e5f9ed; color:#047857; font-weight:600; }
    .status-pill.error { background:#fee2e2; color:#b91c1c; }
    .status-pill.info { background:#e0f2fe; color:#0369a1; }
    .summary-header-row { font-size:.95rem; margin-top:4px; }
    .summary-date-link { color:#2563eb; text-decoration:underline; cursor:default; }
    .summary-table-wrapper { margin-top:10px; overflow-x:auto; border-radius:8px; border:1px solid #cbd5e1; background:#f9fafb; }
    .summary-table { width:100%; border-collapse:collapse; font-size:.9rem; background:#fff; }
    .summary-table th, .summary-table td { border:1px solid #cbd5e1; padding:6px 8px; text-align:left; }
    .summary-table th { background:#e5f0ff; color:#1f2937; font-weight:600; }
    .summary-table td.main-row-cell { background:#fff; }
    .summary-table tr:nth-child(even) td.main-row-cell { background:#f9fafb; }
    .row-not-updated td.main-row-cell { background:#fff7ed; }
    .cell-not-updated { font-weight:600; color:#b45309; }
    .attendance-link { cursor:pointer; text-decoration:underline; color:#111827; }
    .attendance-link:hover { color:#1d4ed8; }
    .absent-row td { background:#fefce8; font-size:.85rem; }
    .summary-footer { margin-top:8px; font-size:.85rem; color:#374151; }
    .darjah-col { width:70px; text-align:center; white-space:nowrap; }
    footer { text-align:center; font-size:.75rem; color:#9ca3af; margin-top:10px; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(15,23,42,.45); display:flex; align-items:center; justify-content:center; z-index:40; }
    .modal-card { background:#fff; border-radius:16px; padding:20px; width:100%; max-width:420px; box-shadow:0 20px 40px rgba(15,23,42,.5); max-height:90vh; overflow-y:auto; }
    .modal-card.modal-lg { max-width:700px; }
    .modal-card h3 { margin:0 0 8px; }
    .modal-card p { margin:0 0 14px; font-size:.9rem; color:#4b5563; }
    .modal-input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; font-size:.95rem; }
    .modal-input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 2px rgba(37,99,235,.25); }
    .modal-actions { margin-top:16px; display:flex; justify-content:flex-end; gap:8px; }
    .status-bersebab { background:#d1fae5; color:#047857; padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:600; }
    .status-tidak-bersebab { background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight:600; }
    .alert-box { padding:12px 16px; border-radius:12px; margin-bottom:12px; font-size:.9rem; }
    .alert-info { background:#e0f2fe; border:1px solid #7dd3fc; color:#0369a1; }
    .alert-warning { background:#fef3c7; border:1px solid #fcd34d; color:#b45309; }
    .notification-row { transition: background 0.15s; }
    .notification-row:hover { background:#eff6ff !important; }
    /* Full attendance green cell */
    .cell-full-attendance { background:#d1fae5 !important; color:#047857; font-weight:600; }
    /* Admin panel styles */
    .admin-panel { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    /* Absence report styles */
    .absence-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:10px; transition:box-shadow 0.15s; }
    .absence-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .absence-card-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
    .absence-card-name { font-weight:600; color:#1f2937; }
    .absence-card-class { font-size:.85rem; color:#6b7280; }
    .absence-card-count { background:#fee2e2; color:#b91c1c; padding:4px 10px; border-radius:999px; font-weight:700; font-size:.9rem; }
    .absence-card-dates { margin-top:10px; padding-top:10px; border-top:1px solid #e5e7eb; font-size:.85rem; color:#4b5563; display:none; }
    .absence-card-dates.show { display:block; }
    .absence-date-item { display:flex; justify-content:space-between; align-items:center; padding:8px; margin:6px 0; background:#f9fafb; border-radius:8px; border:1px solid #e5e7eb; }
    .absence-date-label { font-weight:500; color:#374151; }
    .absence-status-toggle { padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:600; cursor:pointer; border:none; transition:all 0.2s; }
    .absence-status-toggle.bersebab { background:#d1fae5; color:#047857; }
    .absence-status-toggle.tidak_bersebab { background:#fee2e2; color:#b91c1c; }
    @media (max-width:640px) { .header-text h1 { font-size:1.15rem; } .students-header, .student-row { grid-template-columns:42px 1fr 80px; } .students-container { max-height:360px; } }
  </style>
</head>
<body>
<header>
  <div class="header-main">
    <div class="header-logo" id="adminLogoBtn" title="Klik untuk log masuk admin">
      <img src="./icon-192.png" alt="Logo SKSA" />
      <span id="notificationBadge" class="notification-badge"></span>
    </div>
    <div class="header-text">
      <h1>Rekod Kehadiran Harian Murid SKSA</h1>
      <p>Guru hanya perlu tandakan murid <strong>tidak hadir</strong>. Sistem akan kira kehadiran automatik.</p>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="card-header">
      <h2>üìö Rekod Kehadiran <span class="badge" id="yearBadge"></span></h2>
      <div class="date-display" id="todayDisplay">Tarikh:</div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="byClass">Rekod Mengikut Kelas</button>
      <button class="tab-btn" data-tab="summary">Ringkasan Semua Kelas</button>
      <button class="tab-btn" data-tab="admin" id="adminTabBtn" style="display:none;">üîí Admin</button>
    </div>

    <!-- TAB: Mengikut kelas -->
    <div id="tab-byClass" class="tab-panel" style="display:block;">
      <div>
        <label for="classSelect">Pilih kelas:</label>
        <select id="classSelect"><option value="">‚Äî Sila pilih kelas ‚Äî</option></select>
      </div>
      <div class="flex-row">
        <div class="pill">üîÅ <strong>Setiap hari baharu</strong> ‚Äî kehadiran bermula semula.</div>
        <div>
          <button type="button" class="btn btn-outline" id="btnAllPresent">‚úÖ Semua hadir</button>
          <button type="button" class="btn btn-outline" id="btnClearTicks">‚úñ Reset</button>
        </div>
      </div>
      <div id="studentsSection" style="margin-top:16px;display:none;">
        <div class="search-row">
          <label for="searchInput">Carian nama:</label>
          <input id="searchInput" type="text" placeholder='Taip nama murid...' />
        </div>
        <div class="students-container">
          <div class="students-header"><div>No.</div><div>Nama Murid</div><div style="text-align:center;">Tidak hadir</div><div style="text-align:center;">Bersebab</div></div>
          <div id="studentsList"></div>
        </div>
        <div class="flex-row">
          <div class="pill" id="countInfo">üë• Jumlah murid: <strong>0</strong></div>
          <button type="button" class="btn btn-primary" id="btnSave">üíæ Simpan kehadiran</button>
        </div>
        <div class="summary-box" id="summaryBox" style="display:none;">
          <div class="summary-main">
            <div><strong id="summaryTitle">Kehadiran hari ini:</strong><div id="summaryRatio">0/0 hadir</div></div>
            <div id="summaryMini"></div>
          </div>
          <div class="summary-absent" id="summaryAbsent"></div>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>
    </div>

    <!-- TAB: Ringkasan -->
    <div id="tab-summary" class="tab-panel" style="display:none;">
      <div class="subtabs">
        <button class="subtab-btn active" data-subtab="daily">Harian</button>
        <button class="subtab-btn" data-subtab="weekly">Mingguan</button>
        <button class="subtab-btn" data-subtab="monthly">Bulanan</button>
        <button class="subtab-btn" data-subtab="yearly" id="yearlySubtabBtn" style="display:none;">Tahunan</button>
      </div>
      <div id="summaryDailyPanel" class="subtab-panel" style="display:block;">
        <div class="summary-header-row">Rekod Kehadiran Pada <span id="summaryDateLink" class="summary-date-link"></span></div>
        <div class="summary-table-wrapper">
          <table class="summary-table"><thead><tr><th>Bil</th><th class="darjah-col">Darjah</th><th>Kelas</th><th>Kehadiran</th></tr></thead><tbody id="summaryTableBody"></tbody></table>
        </div>
        <div class="summary-footer" id="summaryFooter">Kehadiran : Tiada rekod</div>
      </div>
      <div id="summaryWeeklyPanel" class="subtab-panel" style="display:none;">
        <div class="summary-header-row">Ringkasan Mingguan: <span id="weeklyRangeLabel"></span></div>
        <div class="summary-table-wrapper">
          <table class="summary-table"><thead><tr><th rowspan="2">Bil</th><th rowspan="2" class="darjah-col">Darjah</th><th rowspan="2">Kelas</th><th colspan="5" id="weeklyHeaderSpan">Kehadiran</th></tr><tr id="weeklyDateRow"></tr></thead><tbody id="weeklyTableBody"></tbody></table>
        </div>
        <div class="summary-footer" id="weeklyInfo">Tiada rekod.</div>
      </div>
      <div id="summaryMonthlyPanel" class="subtab-panel" style="display:none;">
        <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
          <span>Ringkasan Bulanan: <span id="monthlyLabel"></span></span>
          <button type="button" class="btn btn-outline" id="btnPrintMonthly">üñ® Cetak</button>
        </div>
        <div class="summary-table-wrapper">
          <table class="summary-table"><thead><tr><th rowspan="2">Bil</th><th rowspan="2" class="darjah-col">Darjah</th><th rowspan="2">Kelas</th><th colspan="31" id="monthlyHeaderSpan">Kehadiran</th></tr><tr id="monthlyDateRow"></tr></thead><tbody id="monthlyTableBody"></tbody></table>
        </div>
        <div class="summary-footer" id="monthlyInfo">Tiada rekod.</div>
      </div>
      <div id="summaryYearlyPanel" class="subtab-panel" style="display:none;">
        <div class="summary-header-row" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <div>Ringkasan Tahunan: <select id="yearlyYearSelect" style="padding:4px 10px;border-radius:999px;border:1px solid #d1d5db;background:#f9fafb;font-size:.85rem;min-width:90px;"></select></div>
        </div>
        <div class="summary-table-wrapper">
          <table class="summary-table"><thead><tr><th>Bil</th><th>Bulan</th><th>Kehadiran</th></tr></thead><tbody id="yearlyTableBody"></tbody></table>
        </div>
        <div class="summary-footer" id="yearlyInfo">Tiada rekod.</div>
      </div>
    </div>

    <!-- TAB: Admin -->
    <div id="tab-admin" class="tab-panel" style="display:none;">
      <div class="summary-box"><div class="summary-main"><div><strong>Mod Admin</strong></div><div>Anda boleh urus kelas, murid, cuti sekolah dan status ketidakhadiran.</div></div></div>
      
      <!-- Admin Function Selector Dropdown -->
      <div style="margin-top:16px;">
        <label for="adminFunctionSelect" style="font-size:.9rem;font-weight:600;color:#374151;">Pilih Fungsi Admin:</label>
        <select id="adminFunctionSelect" style="margin-top:6px;font-size:1rem;padding:10px 14px;">
          <option value="">‚Äî Sila pilih fungsi ‚Äî</option>
          <option value="holidaySettings">üìÖ Tetapan Cuti Sekolah</option>
          <option value="absenceChecker">üìä Semak Murid Tidak Hadir</option>
          <option value="pontengNotif">üîî Notifikasi Murid Ponteng</option>
          <option value="classList">üè´ Senarai Kelas</option>
          <option value="studentEditor">‚úèÔ∏è Sunting Senarai Murid</option>
          <option value="resetData">‚ö†Ô∏è Reset Data</option>
        </select>
      </div>

      <!-- Admin Function Panels -->
      
      <!-- 1. Tetapan Cuti Sekolah -->
      <div id="adminPanel-holidaySettings" class="admin-panel" style="display:none;margin-top:16px;">
        <h3 style="margin:0 0 6px;font-size:1rem;">üìÖ Tetapan Cuti Sekolah</h3>
        <div class="alert-box alert-info" style="margin-top:8px;">
          <strong>Cara Penggunaan:</strong> Klik pada tarikh untuk tandakan sebagai <strong>CUTI</strong>. Klik sekali lagi untuk batalkan.<br>
          <span style="display:inline-block;width:20px;height:20px;background:#fecaca;border:1px solid #f87171;border-radius:4px;vertical-align:middle;margin:0 4px;text-align:center;line-height:20px;font-size:.7rem;">X</span> = Cuti Sekolah &nbsp;
          <span style="display:inline-block;width:20px;height:20px;background:#e5e7eb;border:1px solid #d1d5db;border-radius:4px;vertical-align:middle;margin:0 4px;text-align:center;line-height:20px;font-size:.7rem;color:#9ca3af;">5</span> = Sabtu/Ahad (auto skip)
        </div>
        <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:12px;">
          <span>Bulan: <span id="holidayMonthLabel" style="font-weight:600;"></span></span>
          <div style="display:flex;gap:6px;">
            <button type="button" class="btn btn-outline btn-sm" id="prevMonthBtn">‚óÄ</button>
            <button type="button" class="btn btn-outline btn-sm" id="nextMonthBtn">‚ñ∂</button>
          </div>
        </div>
        <div class="summary-table-wrapper" style="margin-top:10px;">
          <table class="summary-table">
            <thead>
              <tr><th colspan="31" id="holidayHeaderSpan">Tarikh</th></tr>
              <tr id="holidayDateRow"></tr>
            </thead>
            <tbody><tr id="holidayClickRow"></tr></tbody>
          </table>
        </div>
        <div class="summary-footer" id="holidayInfo">Klik pada tarikh untuk tandakan sebagai cuti sekolah.</div>
      </div>

      <!-- 2. Semak Murid Tidak Hadir (NEW) -->
      <div id="adminPanel-absenceChecker" class="admin-panel" style="display:none;margin-top:16px;">
        <h3 style="margin:0 0 6px;font-size:1rem;">üìä Semak Murid Tidak Hadir</h3>
        <div class="alert-box alert-info" style="margin-top:8px;">
          <strong>Paparan:</strong> Senarai murid mengikut bilangan ketidakhadiran (tertinggi di atas). Klik pada nama untuk lihat tarikh tidak hadir.
        </div>
        <div class="flex-row" style="margin-top:12px;gap:12px;">
          <div style="flex:1;">
            <label style="font-size:.85rem;">Jenis Laporan:</label>
            <select id="absenceReportType" style="margin-top:4px;">
              <option value="monthly">Bulanan</option>
              <option value="yearly">Tahunan</option>
            </select>
          </div>
          <div style="flex:1;" id="absenceMonthSelectWrapper">
            <label style="font-size:.85rem;">Pilih Bulan:</label>
            <select id="absenceMonthSelect" style="margin-top:4px;"></select>
          </div>
          <div style="flex:0;">
            <label style="font-size:.85rem;">&nbsp;</label>
            <button type="button" class="btn btn-primary" id="loadAbsenceReportBtn" style="margin-top:4px;">üîç Jana Laporan</button>
          </div>
        </div>
        <div id="absenceReportResult" style="margin-top:16px;"></div>
      </div>

      <!-- 3. Notifikasi Ponteng -->
      <div id="adminPanel-pontengNotif" class="admin-panel" style="display:none;margin-top:16px;">
        <h3 style="margin:0 0 6px;font-size:1rem;">üîî Notifikasi Murid Ponteng (Tidak Bersebab)</h3>
        <div class="alert-box alert-info" style="margin-top:8px;">
          <strong>Cara Penggunaan:</strong><br>
          ‚Ä¢ <span class="status-bersebab">Bersebab</span> = Tidak hadir dengan alasan (sakit, hal keluarga) - <strong>TIDAK DIKIRA PONTENG</strong><br>
          ‚Ä¢ <span class="status-tidak-bersebab">Tidak Bersebab</span> = Ponteng tanpa alasan - <strong>DIKIRA PONTENG</strong><br>
          ‚Ä¢ <strong>Sabtu, Ahad & Cuti Sekolah</strong> tidak dikira sebagai hari ponteng<br>
          ‚Ä¢ Default: Semua ketidakhadiran adalah <strong>Tidak Bersebab (Ponteng)</strong>
        </div>
        <div class="summary-table-wrapper" style="margin-top:12px;">
          <table class="summary-table">
            <thead><tr><th>Bil</th><th>Nama Murid</th><th>Kelas</th><th>Hari Ponteng</th><th>Jenis</th><th>Cadangan Surat</th></tr></thead>
            <tbody id="adminNotificationBody"></tbody>
          </table>
        </div>
        <div class="summary-footer" id="adminNotificationInfo">Tiada notifikasi ponteng.</div>
      </div>

      <!-- 4. Senarai Kelas -->
      <div id="adminPanel-classList" class="admin-panel" style="display:none;margin-top:16px;">
        <h3 style="margin:0 0 6px;font-size:1rem;">üè´ Senarai Kelas</h3>
        <div class="summary-table-wrapper">
          <table class="summary-table"><thead><tr><th>Bil</th><th>Darjah</th><th>Kod</th><th>Nama Kelas</th><th>Bil. Murid</th><th>Tindakan</th></tr></thead><tbody id="adminClassTableBody"></tbody></table>
        </div>
        <div style="margin-top:10px;padding:10px 12px;border-radius:12px;background:#f9fafb;border:1px dashed #cbd5e1;">
          <h4 style="margin:0 0 8px;font-size:.95rem;">Tambah Kelas Baharu</h4>
          <div class="flex-row" style="gap:8px;">
            <input id="adminNewDarjah" type="text" placeholder="Darjah (D4)" style="flex:0 0 80px;padding:6px 8px;border-radius:999px;border:1px solid #d1d5db;font-size:.85rem;">
            <input id="adminNewCode" type="text" placeholder="Kod (4B)" style="flex:0 0 80px;padding:6px 8px;border-radius:999px;border:1px solid #d1d5db;font-size:.85rem;">
            <input id="adminNewLabel" type="text" placeholder="Nama (BESTARI)" style="flex:1;padding:6px 8px;border-radius:999px;border:1px solid #d1d5db;font-size:.85rem;">
            <button type="button" class="btn btn-primary btn-sm" id="adminAddClassBtn">+ Tambah</button>
          </div>
          <div id="adminClassMsg" style="margin-top:6px;font-size:.8rem;color:#6b7280;"></div>
        </div>
      </div>

      <!-- 6. Sunting Senarai Murid -->
      <div id="adminPanel-studentEditor" class="admin-panel" style="display:none;margin-top:16px;">
        <h3 style="margin:0 0 6px;font-size:1rem;">‚úèÔ∏è Sunting Senarai Murid</h3>
        <label for="adminStudentClassSelect" style="font-size:.85rem;">Pilih kelas:</label>
        <select id="adminStudentClassSelect" style="margin-top:4px;margin-bottom:8px;"></select>
        <textarea id="adminStudentTextarea" rows="10" style="width:100%;padding:8px 10px;border-radius:12px;border:1px solid #d1d5db;font-size:.9rem;resize:vertical;" placeholder="Satu nama murid bagi setiap baris."></textarea>
        <div class="flex-row" style="margin-top:8px;">
          <div id="adminStudentCount" class="pill">Bil. murid: 0</div>
          <button type="button" class="btn btn-primary" id="adminSaveStudentsBtn">üíæ Simpan ke Firebase</button>
        </div>
        <div id="adminStudentMsg" style="margin-top:6px;font-size:.8rem;color:#6b7280;">Perubahan akan disimpan di Firebase Realtime Database.</div>
      </div>

      <!-- 7. Reset Data -->
      <div id="adminPanel-resetData" class="admin-panel" style="display:none;margin-top:16px;">
        <div style="padding:16px;border-radius:12px;background:#fef2f2;border:1px solid #fecaca;">
          <h3 style="margin:0 0 6px;font-size:1rem;color:#b91c1c;">‚ö†Ô∏è Reset Data Kehadiran</h3>
          <p style="font-size:.85rem;color:#7f1d1d;margin:0 0 12px;">Padam SEMUA rekod kehadiran dan status ketidakhadiran. Tindakan ini <strong>tidak boleh dibatalkan</strong>.</p>
          <div class="flex-row" style="gap:8px;">
            <button type="button" class="btn btn-danger" id="resetAttendanceBtn">üóëÔ∏è Reset Semua Data Kehadiran</button>
            <button type="button" class="btn btn-outline" id="resetHolidaysBtn" style="border-color:#f87171;color:#b91c1c;">üóëÔ∏è Reset Senarai Cuti</button>
          </div>
          <div id="resetMsg" style="margin-top:8px;font-size:.8rem;color:#6b7280;"></div>
        </div>
      </div>

    </div>
  </section>
  <footer>SK Sri Aman ¬∑ Modul Kehadiran Harian Murid (Firebase Realtime Database)</footer>
</main>

<!-- Modal Log Masuk Admin -->
<div id="adminModal" class="modal-backdrop" style="display:none;">
  <div class="modal-card">
    <h3>üîê Log Masuk Admin</h3>
    <p>Masukkan kata laluan admin untuk mengakses tetapan.</p>
    <label for="adminPassword" style="font-size:.85rem;color:#374151;">Kata Laluan</label>
    <input id="adminPassword" type="password" class="modal-input" placeholder="Masukkan kata laluan" />
    <div id="adminModalError" style="margin-top:6px;font-size:.8rem;color:#b91c1c;"></div>
    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" id="adminCancelBtn">Batal</button>
      <button type="button" class="btn btn-primary" id="adminLoginBtn">Log Masuk</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js">
// ================= Matrix Cuti Table (Option 1) =================
let matrixYear = new Date().getFullYear();
let matrixMonth = new Date().getMonth();

function daysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}

function formatYM(y, m) {
  return MONTH_NAMES_MS[m] + ' ' + y;
}

function buildMatrixHeader(y, m) {
  const totalDays = daysInMonth(y, m);
  let ths = '<th style="position:sticky;left:0;background:#e5f0ff;z-index:3;">Kelas</th>';
  for (let d = 1; d <= totalDays; d++) {
    const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const dt = new Date(y, m, d);
    const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
    const isHolidayDay = holidaysCache[dateKey];
    let style = 'cursor:pointer;';
    if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;cursor:default;';
    if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
    ths += `<th style="${style}" ${!isWeekendDay ? `onclick="toggleMatrixHoliday('${dateKey}')"` : ''} title="${isWeekendDay?'Hujung minggu':(isHolidayDay?'Cuti - klik untuk batalkan':'Klik untuk tandakan cuti')}">${d}</th>`;
  }
  return ths;
}

function buildMatrixRows(y, m, allByDate) {
  const totalDays = daysInMonth(y, m);
  let rows = '';
  summaryConfig.forEach(cfg => {
    rows += `<tr><td style="position:sticky;left:0;background:#fff;font-weight:600;z-index:2;">${cfg.code} - ${cfg.kelasLabel}</td>`;
    for (let d = 1; d <= totalDays; d++) {
      const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      const dt = new Date(y, m, d);
      const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
      const isHolidayDay = holidaysCache[dateKey];
      const rec = allByDate[dateKey]?.[cfg.code];
      let content = '-';
      let style = 'text-align:center;';
      if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;';
      if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
      if (rec && !isWeekendDay && !isHolidayDay) content = (rec.present||0) + '/' + (rec.total||0);
      rows += `<td style="${style}">${content}</td>`;
    }
    rows += '</tr>';
  });
  return rows;
}

function renderMatrixCuti() {
  if (!isAdmin) return;
  const container = document.getElementById('matrixCutiContainer');
  if (!container) return;
  const y = matrixYear, m = matrixMonth;
  const totalDays = daysInMonth(y, m);
  const monthLabel = formatYM(y, m);
  container.innerHTML = `
    <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
      <strong>Jadual Cuti & Kehadiran (Matrix): ${monthLabel}</strong>
      <div style="display:flex;gap:6px;">
        <button type="button" class="btn btn-outline btn-sm" onclick="prevMatrixMonth()">‚óÄ</button>
        <button type="button" class="btn btn-outline btn-sm" onclick="nextMatrixMonth()">‚ñ∂</button>
      </div>
    </div>
    <div class="summary-table-wrapper" style="margin-top:8px;overflow:auto;">
      <table class="summary-table">
        <thead><tr id="matrixHeaderRow"></tr></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>
    <div class="summary-footer">Klik tarikh (header) untuk tandakan CUTI bagi semua kelas. Sabtu/Ahad auto cuti.</div>
  `;
  const headerRow = container.querySelector('#matrixHeaderRow');
  headerRow.innerHTML = buildMatrixHeader(y, m);

  const dateKeys = [];
  for (let d = 1; d <= totalDays; d++) {
    dateKeys.push(y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0'));
  }
  Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
    const allByDate = {};
    snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
    const body = container.querySelector('#matrixBody');
    body.innerHTML = buildMatrixRows(y, m, allByDate);
  });
}

function toggleMatrixHoliday(dateKey) {
  toggleHoliday(dateKey).then(() => {
    renderMatrixCuti();
    loadMonthlySummary();
    loadWeeklySummary();
    loadDailySummary();
    recomputeNotificationsForYear(String(currentYear));
  });
}

function prevMatrixMonth() {
  matrixMonth--;
  if (matrixMonth < 0) { matrixMonth = 11; matrixYear--; }
  renderMatrixCuti();
}
function nextMatrixMonth() {
  matrixMonth++;
  if (matrixMonth > 11) { matrixMonth = 0; matrixYear++; }
  renderMatrixCuti();
}

// Hook render when admin tab is opened
const _origAdminTabHandler = document.getElementById('adminTabBtn');
if (_origAdminTabHandler) {
  _origAdminTabHandler.addEventListener('click', () => {
    loadHolidays().then(renderMatrixCuti);
  });
}


function getWeekKey(dateKey){
    const d = new Date(dateKey);
    const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return d.getFullYear() + "-W" + String(week).padStart(2,'0');
}
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js">
// ================= Matrix Cuti Table (Option 1) =================
let matrixYear = new Date().getFullYear();
let matrixMonth = new Date().getMonth();

function daysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}

function formatYM(y, m) {
  return MONTH_NAMES_MS[m] + ' ' + y;
}

function buildMatrixHeader(y, m) {
  const totalDays = daysInMonth(y, m);
  let ths = '<th style="position:sticky;left:0;background:#e5f0ff;z-index:3;">Kelas</th>';
  for (let d = 1; d <= totalDays; d++) {
    const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const dt = new Date(y, m, d);
    const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
    const isHolidayDay = holidaysCache[dateKey];
    let style = 'cursor:pointer;';
    if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;cursor:default;';
    if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
    ths += `<th style="${style}" ${!isWeekendDay ? `onclick="toggleMatrixHoliday('${dateKey}')"` : ''} title="${isWeekendDay?'Hujung minggu':(isHolidayDay?'Cuti - klik untuk batalkan':'Klik untuk tandakan cuti')}">${d}</th>`;
  }
  return ths;
}

function buildMatrixRows(y, m, allByDate) {
  const totalDays = daysInMonth(y, m);
  let rows = '';
  summaryConfig.forEach(cfg => {
    rows += `<tr><td style="position:sticky;left:0;background:#fff;font-weight:600;z-index:2;">${cfg.code} - ${cfg.kelasLabel}</td>`;
    for (let d = 1; d <= totalDays; d++) {
      const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      const dt = new Date(y, m, d);
      const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
      const isHolidayDay = holidaysCache[dateKey];
      const rec = allByDate[dateKey]?.[cfg.code];
      let content = '-';
      let style = 'text-align:center;';
      if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;';
      if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
      if (rec && !isWeekendDay && !isHolidayDay) content = (rec.present||0) + '/' + (rec.total||0);
      rows += `<td style="${style}">${content}</td>`;
    }
    rows += '</tr>';
  });
  return rows;
}

function renderMatrixCuti() {
  if (!isAdmin) return;
  const container = document.getElementById('matrixCutiContainer');
  if (!container) return;
  const y = matrixYear, m = matrixMonth;
  const totalDays = daysInMonth(y, m);
  const monthLabel = formatYM(y, m);
  container.innerHTML = `
    <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
      <strong>Jadual Cuti & Kehadiran (Matrix): ${monthLabel}</strong>
      <div style="display:flex;gap:6px;">
        <button type="button" class="btn btn-outline btn-sm" onclick="prevMatrixMonth()">‚óÄ</button>
        <button type="button" class="btn btn-outline btn-sm" onclick="nextMatrixMonth()">‚ñ∂</button>
      </div>
    </div>
    <div class="summary-table-wrapper" style="margin-top:8px;overflow:auto;">
      <table class="summary-table">
        <thead><tr id="matrixHeaderRow"></tr></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>
    <div class="summary-footer">Klik tarikh (header) untuk tandakan CUTI bagi semua kelas. Sabtu/Ahad auto cuti.</div>
  `;
  const headerRow = container.querySelector('#matrixHeaderRow');
  headerRow.innerHTML = buildMatrixHeader(y, m);

  const dateKeys = [];
  for (let d = 1; d <= totalDays; d++) {
    dateKeys.push(y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0'));
  }
  Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
    const allByDate = {};
    snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
    const body = container.querySelector('#matrixBody');
    body.innerHTML = buildMatrixRows(y, m, allByDate);
  });
}

function toggleMatrixHoliday(dateKey) {
  toggleHoliday(dateKey).then(() => {
    renderMatrixCuti();
    loadMonthlySummary();
    loadWeeklySummary();
    loadDailySummary();
    recomputeNotificationsForYear(String(currentYear));
  });
}

function prevMatrixMonth() {
  matrixMonth--;
  if (matrixMonth < 0) { matrixMonth = 11; matrixYear--; }
  renderMatrixCuti();
}
function nextMatrixMonth() {
  matrixMonth++;
  if (matrixMonth > 11) { matrixMonth = 0; matrixYear++; }
  renderMatrixCuti();
}

// Hook render when admin tab is opened
const _origAdminTabHandler = document.getElementById('adminTabBtn');
if (_origAdminTabHandler) {
  _origAdminTabHandler.addEventListener('click', () => {
    loadHolidays().then(renderMatrixCuti);
  });
}


function getWeekKey(dateKey){
    const d = new Date(dateKey);
    const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return d.getFullYear() + "-W" + String(week).padStart(2,'0');
}
</script>

<script src="database.js">
// ================= Matrix Cuti Table (Option 1) =================
let matrixYear = new Date().getFullYear();
let matrixMonth = new Date().getMonth();

function daysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}

function formatYM(y, m) {
  return MONTH_NAMES_MS[m] + ' ' + y;
}

function buildMatrixHeader(y, m) {
  const totalDays = daysInMonth(y, m);
  let ths = '<th style="position:sticky;left:0;background:#e5f0ff;z-index:3;">Kelas</th>';
  for (let d = 1; d <= totalDays; d++) {
    const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const dt = new Date(y, m, d);
    const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
    const isHolidayDay = holidaysCache[dateKey];
    let style = 'cursor:pointer;';
    if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;cursor:default;';
    if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
    ths += `<th style="${style}" ${!isWeekendDay ? `onclick="toggleMatrixHoliday('${dateKey}')"` : ''} title="${isWeekendDay?'Hujung minggu':(isHolidayDay?'Cuti - klik untuk batalkan':'Klik untuk tandakan cuti')}">${d}</th>`;
  }
  return ths;
}

function buildMatrixRows(y, m, allByDate) {
  const totalDays = daysInMonth(y, m);
  let rows = '';
  summaryConfig.forEach(cfg => {
    rows += `<tr><td style="position:sticky;left:0;background:#fff;font-weight:600;z-index:2;">${cfg.code} - ${cfg.kelasLabel}</td>`;
    for (let d = 1; d <= totalDays; d++) {
      const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      const dt = new Date(y, m, d);
      const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
      const isHolidayDay = holidaysCache[dateKey];
      const rec = allByDate[dateKey]?.[cfg.code];
      let content = '-';
      let style = 'text-align:center;';
      if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;';
      if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
      if (rec && !isWeekendDay && !isHolidayDay) content = (rec.present||0) + '/' + (rec.total||0);
      rows += `<td style="${style}">${content}</td>`;
    }
    rows += '</tr>';
  });
  return rows;
}

function renderMatrixCuti() {
  if (!isAdmin) return;
  const container = document.getElementById('matrixCutiContainer');
  if (!container) return;
  const y = matrixYear, m = matrixMonth;
  const totalDays = daysInMonth(y, m);
  const monthLabel = formatYM(y, m);
  container.innerHTML = `
    <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
      <strong>Jadual Cuti & Kehadiran (Matrix): ${monthLabel}</strong>
      <div style="display:flex;gap:6px;">
        <button type="button" class="btn btn-outline btn-sm" onclick="prevMatrixMonth()">‚óÄ</button>
        <button type="button" class="btn btn-outline btn-sm" onclick="nextMatrixMonth()">‚ñ∂</button>
      </div>
    </div>
    <div class="summary-table-wrapper" style="margin-top:8px;overflow:auto;">
      <table class="summary-table">
        <thead><tr id="matrixHeaderRow"></tr></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>
    <div class="summary-footer">Klik tarikh (header) untuk tandakan CUTI bagi semua kelas. Sabtu/Ahad auto cuti.</div>
  `;
  const headerRow = container.querySelector('#matrixHeaderRow');
  headerRow.innerHTML = buildMatrixHeader(y, m);

  const dateKeys = [];
  for (let d = 1; d <= totalDays; d++) {
    dateKeys.push(y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0'));
  }
  Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
    const allByDate = {};
    snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
    const body = container.querySelector('#matrixBody');
    body.innerHTML = buildMatrixRows(y, m, allByDate);
  });
}

function toggleMatrixHoliday(dateKey) {
  toggleHoliday(dateKey).then(() => {
    renderMatrixCuti();
    loadMonthlySummary();
    loadWeeklySummary();
    loadDailySummary();
    recomputeNotificationsForYear(String(currentYear));
  });
}

function prevMatrixMonth() {
  matrixMonth--;
  if (matrixMonth < 0) { matrixMonth = 11; matrixYear--; }
  renderMatrixCuti();
}
function nextMatrixMonth() {
  matrixMonth++;
  if (matrixMonth > 11) { matrixMonth = 0; matrixYear++; }
  renderMatrixCuti();
}

// Hook render when admin tab is opened
const _origAdminTabHandler = document.getElementById('adminTabBtn');
if (_origAdminTabHandler) {
  _origAdminTabHandler.addEventListener('click', () => {
    loadHolidays().then(renderMatrixCuti);
  });
}


function getWeekKey(dateKey){
    const d = new Date(dateKey);
    const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return d.getFullYear() + "-W" + String(week).padStart(2,'0');
}
</script>


<script>
(function() {
  'use strict';
  firebase.initializeApp(firebaseConfig);
  
    
    window.today = new Date();
window.db = firebase.database();
const db = firebase.database();

  const MONTH_NAMES_MS = ["Januari","Februari","Mac","April","Mei","Jun","Julai","Ogos","September","Oktober","November","Disember"];

  function formatDateKey(date) {
    return date.getFullYear() + "-" + String(date.getMonth()+1).padStart(2,'0') + "-" + String(date.getDate()).padStart(2,'0');
  }
  function formatHumanDate(date) {
    return String(date.getDate()).padStart(2,'0') + " " + MONTH_NAMES_MS[date.getMonth()] + " " + date.getFullYear();
  }
  function formatShortDM(date) {
    return String(date.getDate()).padStart(2,'0') + "/" + String(date.getMonth()+1).padStart(2,'0');
  }
  function dateFromKey(key) {
    return new Date(parseInt(key.slice(0,4)), parseInt(key.slice(5,7))-1, parseInt(key.slice(8,10)));
  }

  const today = new Date();
  const todayKey = formatDateKey(today);
  const todayHuman = formatHumanDate(today);
  const currentYear = today.getFullYear();

  // DOM refs
  const yearBadge = document.getElementById('yearBadge');
  const todayDisplay = document.getElementById('todayDisplay');
  const summaryDateLink = document.getElementById('summaryDateLink');
  const classSelect = document.getElementById('classSelect');
  const studentsSection = document.getElementById('studentsSection');
  const studentsList = document.getElementById('studentsList');
  const countInfo = document.getElementById('countInfo');
  const btnSave = document.getElementById('btnSave');
  const btnAllPresent = document.getElementById('btnAllPresent');
  const btnClearTicks = document.getElementById('btnClearTicks');
  const summaryBox = document.getElementById('summaryBox');
  const summaryTitle = document.getElementById('summaryTitle');
  const summaryRatio = document.getElementById('summaryRatio');
  const summaryMini = document.getElementById('summaryMini');
  const summaryAbsent = document.getElementById('summaryAbsent');
  const statusBar = document.getElementById('statusBar');
  const searchInput = document.getElementById('searchInput');
  const summaryTableBody = document.getElementById('summaryTableBody');
  const summaryFooter = document.getElementById('summaryFooter');
  const weeklyRangeLabel = document.getElementById('weeklyRangeLabel');
  const weeklyHeaderSpan = document.getElementById('weeklyHeaderSpan');
  const weeklyDateRow = document.getElementById('weeklyDateRow');
  const weeklyTableBody = document.getElementById('weeklyTableBody');
  const weeklyInfo = document.getElementById('weeklyInfo');
  const monthlyLabel = document.getElementById('monthlyLabel');
  const monthlyHeaderSpan = document.getElementById('monthlyHeaderSpan');
  const monthlyDateRow = document.getElementById('monthlyDateRow');
  const monthlyTableBody = document.getElementById('monthlyTableBody');
  const monthlyInfo = document.getElementById('monthlyInfo');
  const btnPrintMonthly = document.getElementById('btnPrintMonthly');
  const yearlySubtabBtn = document.getElementById('yearlySubtabBtn');
  const yearlyYearSelect = document.getElementById('yearlyYearSelect');
  const yearlyTableBody = document.getElementById('yearlyTableBody');
  const yearlyInfo = document.getElementById('yearlyInfo');
  const adminLogoBtn = document.getElementById('adminLogoBtn');
  const adminModal = document.getElementById('adminModal');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminCancelBtn = document.getElementById('adminCancelBtn');
  const adminModalError = document.getElementById('adminModalError');
  const adminTabBtn = document.getElementById('adminTabBtn');
  const notificationBadge = document.getElementById('notificationBadge');
  const adminNotificationBody = document.getElementById('adminNotificationBody');
  const adminNotificationInfo = document.getElementById('adminNotificationInfo');
  const adminClassTableBody = document.getElementById('adminClassTableBody');
  const adminNewDarjah = document.getElementById('adminNewDarjah');
  const adminNewCode = document.getElementById('adminNewCode');
  const adminNewLabel = document.getElementById('adminNewLabel');
  const adminAddClassBtn = document.getElementById('adminAddClassBtn');
  const adminClassMsg = document.getElementById('adminClassMsg');
  const adminStudentClassSelect = document.getElementById('adminStudentClassSelect');
  const adminStudentTextarea = document.getElementById('adminStudentTextarea');
  const adminStudentCount = document.getElementById('adminStudentCount');
  const adminSaveStudentsBtn = document.getElementById('adminSaveStudentsBtn');
  const adminStudentMsg = document.getElementById('adminStudentMsg');

  // Holiday Calendar DOM refs
  const holidayMonthLabel = document.getElementById('holidayMonthLabel');
  const holidayHeaderSpan = document.getElementById('holidayHeaderSpan');
  const holidayDateRow = document.getElementById('holidayDateRow');
  const holidayClickRow = document.getElementById('holidayClickRow');
  const holidayInfo = document.getElementById('holidayInfo');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const resetAttendanceBtn = document.getElementById('resetAttendanceBtn');
  const resetHolidaysBtn = document.getElementById('resetHolidaysBtn');
  const resetMsg = document.getElementById('resetMsg');
  
  // Calendar state
  let calendarYear = currentYear;
  let calendarMonth = today.getMonth();

  yearBadge.textContent = "Tahun " + currentYear;
  todayDisplay.textContent = "Tarikh: " + todayHuman;
  summaryDateLink.textContent = todayHuman;

  function updateDateDisplayWithHolidayCheck() {
    if (isHoliday(todayKey)) {
      todayDisplay.innerHTML = "Tarikh: " + todayHuman + " <span style='color:#dc2626;font-weight:700;'>üèñÔ∏è CUTI</span>";
    } else {
      todayDisplay.textContent = "Tarikh: " + todayHuman;
    }
  }

  function setStatus(msg, type) {
    statusBar.innerHTML = "";
    if (!msg) return;
    const span = document.createElement('span');
    span.className = 'status-pill' + (type ? ' ' + type : '');
    span.textContent = msg;
    statusBar.appendChild(span);
  }
  function clearStatus() { statusBar.innerHTML = ""; }

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      document.getElementById('tab-byClass').style.display = tab === 'byClass' ? 'block' : 'none';
      document.getElementById('tab-summary').style.display = tab === 'summary' ? 'block' : 'none';
      document.getElementById('tab-admin').style.display = tab === 'admin' ? 'block' : 'none';
      if (tab === 'admin') { loadStatusManagement(); recomputeNotificationsForYear(String(currentYear)); }
    });
  });

  document.querySelectorAll('.subtab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const sub = btn.dataset.subtab;
      document.getElementById('summaryDailyPanel').style.display = sub === 'daily' ? 'block' : 'none';
      document.getElementById('summaryWeeklyPanel').style.display = sub === 'weekly' ? 'block' : 'none';
      document.getElementById('summaryMonthlyPanel').style.display = sub === 'monthly' ? 'block' : 'none';
      document.getElementById('summaryYearlyPanel').style.display = sub === 'yearly' ? 'block' : 'none';
      if (sub === 'yearly' && !yearlyInitialised) initYearlySummary();
    });
  });

  btnPrintMonthly.addEventListener('click', () => window.print());

  // Admin login
  let isAdmin = false;
  const ADMIN_PASSWORD = "admin123";

  function openAdminModal() {
    adminModal.style.display = 'flex';
    adminPasswordInput.value = "";
    adminModalError.textContent = "";
    setTimeout(() => adminPasswordInput.focus(), 20);
  }
  function closeAdminModal() { adminModal.style.display = 'none'; }
  function tryAdminLogin() {
    if (adminPasswordInput.value.trim() === ADMIN_PASSWORD) {
      isAdmin = true;
      closeAdminModal();
      adminTabBtn.style.display = 'inline-block';
      yearlySubtabBtn.style.display = 'inline-block';
      setStatus('Log masuk admin berjaya.', 'info');
      ensureYearlyData().then(() => recomputeNotificationsForYear(String(currentYear)));
    } else {
      adminModalError.textContent = 'Kata laluan tidak sah.';
    }
  }

  adminLogoBtn.addEventListener('click', openAdminModal);
  adminCancelBtn.addEventListener('click', closeAdminModal);
  adminLoginBtn.addEventListener('click', tryAdminLogin);
  adminPasswordInput.addEventListener('keydown', e => { if (e.key === 'Enter') tryAdminLogin(); });

  // Fungsi untuk sort summaryConfig mengikut Darjah (D1-D6) dan Kelas (B, C, G)
  function sortSummaryConfig() {
    const kelasOrder = { 'BESTARI': 1, 'CEMERLANG': 2, 'GEMILANG': 3 };
    summaryConfig.sort((a, b) => {
      // Extract darjah number (D1 -> 1, D2 -> 2, etc)
      const darjahA = parseInt(a.darjah.replace(/\D/g, '')) || 0;
      const darjahB = parseInt(b.darjah.replace(/\D/g, '')) || 0;
      
      // Compare darjah first
      if (darjahA !== darjahB) return darjahA - darjahB;
      
      // If same darjah, compare by kelas label order (BESTARI < CEMERLANG < GEMILANG)
      const orderA = kelasOrder[a.kelasLabel.toUpperCase()] || 99;
      const orderB = kelasOrder[b.kelasLabel.toUpperCase()] || 99;
      if (orderA !== orderB) return orderA - orderB;
      
      // Fallback: sort by code alphabetically
      return a.code.localeCompare(b.code);
    });
  }

  // Data loading
  function loadClassConfigFromDB() {
    return db.ref('config/classes').once('value').then(snap => {
      const val = snap.val();
      console.log('Data dari Firebase:', val); // Debug log
      
      if (val && val.classData) {
        // Clear existing data
        for (const key in classData) delete classData[key];
        
        // Load classData - handle both array and object format from Firebase
        Object.keys(val.classData).forEach(classCode => {
          const students = val.classData[classCode];
          // Firebase may store array as object with numeric keys
          if (Array.isArray(students)) {
            classData[classCode] = students;
          } else if (typeof students === 'object' && students !== null) {
            // Convert object {0: "name1", 1: "name2"} to array ["name1", "name2"]
            classData[classCode] = Object.values(students);
          }
        });
        console.log('classData loaded:', classData); // Debug log
      }
      
      if (val && val.summaryConfig) {
        summaryConfig.length = 0;
        // Handle both array and object format
        if (Array.isArray(val.summaryConfig)) {
          val.summaryConfig.forEach(item => summaryConfig.push(item));
        } else if (typeof val.summaryConfig === 'object') {
          Object.values(val.summaryConfig).forEach(item => summaryConfig.push(item));
        }
        // Sort summaryConfig selepas load
        sortSummaryConfig();
        console.log('summaryConfig loaded & sorted:', summaryConfig); // Debug log
      }
    }).catch(err => console.error('Gagal memuatkan config kelas:', err));
  }

  function saveClassConfigToDB() {
    return db.ref('config/classes').set({ classData: classData, summaryConfig: summaryConfig })
      .then(() => console.log('Config disimpan ke Firebase.'))
      .catch(err => console.error('Gagal menyimpan config:', err));
  }

  // Absence status management
  let absenceStatusCache = {};

  function loadAbsenceStatus() {
    return db.ref('absenceStatus').once('value').then(snap => {
      absenceStatusCache = snap.val() || {};
    }).catch(err => { console.error('Gagal memuatkan status:', err); absenceStatusCache = {}; });
  }

  function getAbsenceStatus(dateKey, classCode, studentName) {
    try {
      const safeName = studentName.replace(/[.#$\/\[\]]/g, '_');
      return (absenceStatusCache[dateKey]?.[classCode]?.[safeName]) || 'tidak_bersebab';
    } catch(e) { return 'tidak_bersebab'; }
  }

  function setAbsenceStatus(dateKey, classCode, studentName, status) {
    const safeName = studentName.replace(/[.#$\/\[\]]/g, '_');
    const path = `absenceStatus/${dateKey}/${classCode}/${safeName}`;
    return db.ref(path).set(status).then(() => {
      if (!absenceStatusCache[dateKey]) absenceStatusCache[dateKey] = {};
      if (!absenceStatusCache[dateKey][classCode]) absenceStatusCache[dateKey][classCode] = {};
      absenceStatusCache[dateKey][classCode][safeName] = status;
    });
  }

  // ============ Holiday Calendar Management ============
  let holidaysCache = {};
  const DAY_NAMES_MS = ['Ahad', 'Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu'];

  function loadHolidays() {
    return db.ref('holidays').once('value').then(snap => {
      holidaysCache = snap.val() || {};
      console.log('Holidays loaded:', holidaysCache);
    }).catch(err => { console.error('Gagal memuatkan cuti:', err); holidaysCache = {}; });
  }

  function isHoliday(dateKey) {
    return holidaysCache[dateKey] ? true : false;
  }

  function isWeekend(dateKey) {
    const date = dateFromKey(dateKey);
    const day = date.getDay(); // 0 = Ahad, 6 = Sabtu
    return day === 0 || day === 6;
  }

  function isSchoolDay(dateKey) {
    return !isWeekend(dateKey) && !isHoliday(dateKey);
  }

  function toggleHoliday(dateKey) {
    if (holidaysCache[dateKey]) {
      return db.ref(`holidays/${dateKey}`).remove().then(() => {
        delete holidaysCache[dateKey];
      });
    } else {
      return db.ref(`holidays/${dateKey}`).set('Cuti Sekolah').then(() => {
        holidaysCache[dateKey] = 'Cuti Sekolah';
      });
    }
  }

  function renderHolidayCalendar() {
    if (!holidayDateRow || !holidayClickRow) return;
    
    // Update month label
    holidayMonthLabel.textContent = MONTH_NAMES_MS[calendarMonth] + ' ' + calendarYear;
    
    // Get total days in month
    const totalDays = new Date(calendarYear, calendarMonth + 1, 0).getDate();
    holidayHeaderSpan.colSpan = totalDays;
    
    // Build header row with date numbers
    let headerHtml = '';
    let clickRowHtml = '';
    
    for (let d = 1; d <= totalDays; d++) {
      const dateKey = calendarYear + '-' + String(calendarMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
      const date = new Date(calendarYear, calendarMonth, d);
      const dayOfWeek = date.getDay();
      const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6;
      const isHolidayDay = holidaysCache[dateKey];
      const isToday = dateKey === todayKey;
      
      // Header cell with date number
      let headerStyle = '';
      if (isWeekendDay) headerStyle = 'background:#f3f4f6;color:#9ca3af;';
      headerHtml += `<th style="${headerStyle}">${d}</th>`;
      
      // Clickable cell
      let cellStyle = 'cursor:pointer;text-align:center;padding:8px 4px;';
      let cellContent = '-';
      let cellTitle = 'Klik untuk tandakan cuti';
      
      if (isWeekendDay) {
        cellStyle += 'background:#f3f4f6;color:#9ca3af;cursor:default;';
        cellContent = '-';
        cellTitle = 'Hujung minggu (auto skip)';
      } else if (isHolidayDay) {
        cellStyle += 'background:#fecaca;color:#b91c1c;font-weight:600;';
        cellContent = 'X';
        cellTitle = 'Cuti - Klik untuk batalkan';
      }
      
      if (isToday) {
        cellStyle += 'border:2px solid #2563eb;';
      }
      
      const clickAttr = !isWeekendDay ? `data-date="${dateKey}" onclick="window.toggleHolidayDate('${dateKey}')"` : '';
      clickRowHtml += `<td style="${cellStyle}" title="${cellTitle}" ${clickAttr}>${cellContent}</td>`;
    }
    
    holidayDateRow.innerHTML = headerHtml;
    holidayClickRow.innerHTML = clickRowHtml;
    
    // Update info
    const holidayCount = Object.keys(holidaysCache).filter(k => {
      return k.startsWith(calendarYear + '-' + String(calendarMonth + 1).padStart(2, '0'));
    }).length;
    
    holidayInfo.textContent = holidayCount > 0 
      ? `${holidayCount} hari cuti ditandakan untuk ${MONTH_NAMES_MS[calendarMonth]} ${calendarYear}. Sabtu & Ahad auto skip.`
      : 'Klik pada tarikh untuk tandakan cuti. Sabtu & Ahad auto skip.';
  }

  // Global function for onclick
  window.toggleHolidayDate = function(dateKey) {
    toggleHoliday(dateKey).then(() => {
      updateDateDisplayWithHolidayCheck();
      renderHolidayCalendar();
      // Reload summaries to reflect holiday changes
      loadDailySummary();
      loadWeeklySummary();
      loadMonthlySummary();
      recomputeNotificationsForYear(String(currentYear));
    });
  };

  // Calendar navigation
  if (prevMonthBtn) {
    prevMonthBtn.addEventListener('click', () => {
      calendarMonth--;
      if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
      renderHolidayCalendar();
    });
  }

  if (nextMonthBtn) {
    nextMonthBtn.addEventListener('click', () => {
      calendarMonth++;
      if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
      renderHolidayCalendar();
    });
  }

  // ============ Reset Data Functions ============
  if (resetAttendanceBtn) {
    resetAttendanceBtn.addEventListener('click', () => {
      if (!confirm('‚ö†Ô∏è AMARAN!\n\nAnda akan MEMADAM SEMUA:\n‚Ä¢ Rekod kehadiran\n‚Ä¢ Status ketidakhadiran (bersebab/tidak bersebab)\n\nTindakan ini TIDAK BOLEH dibatalkan!\n\nTeruskan?')) return;
      if (!confirm('Sahkan sekali lagi: Padam SEMUA data kehadiran?')) return;
      
      resetMsg.textContent = 'Memadam data...';
      resetMsg.style.color = '#b91c1c';
      
      Promise.all([
        db.ref('kehadiran').remove(),
        db.ref('absenceStatus').remove()
      ]).then(() => {
        absenceStatusCache = {};
        yearlyRaw = null;
        yearlyInitialised = false;
        notifications = [];
        
        resetMsg.textContent = 'Semua data kehadiran telah dipadam!';
        resetMsg.style.color = '#047857';
        
        renderNotificationBadge();
        renderAdminNotifications(String(currentYear));
        loadDailySummary();
        loadWeeklySummary();
        loadMonthlySummary();
      }).catch(err => {
        resetMsg.textContent = 'Ralat: ' + err.message;
        resetMsg.style.color = '#b91c1c';
      });
    });
  }

  if (resetHolidaysBtn) {
    resetHolidaysBtn.addEventListener('click', () => {
      if (!confirm('Padam semua senarai cuti sekolah?')) return;
      
      resetMsg.textContent = 'Memadam senarai cuti...';
      resetMsg.style.color = '#b91c1c';
      
      db.ref('holidays').remove().then(() => {
        holidaysCache = {};
        renderHolidayCalendar();
        recomputeNotificationsForYear(String(currentYear));
        resetMsg.textContent = 'Senarai cuti telah dipadam!';
        resetMsg.style.color = '#047857';
      }).catch(err => {
        resetMsg.textContent = 'Ralat: ' + err.message;
        resetMsg.style.color = '#b91c1c';
      });
    });
  }

  // UI functions
  function populateClassDropdown() {
    const prev = classSelect.value;
    classSelect.innerHTML = '<option value="">‚Äî Sila pilih kelas ‚Äî</option>';
    summaryConfig.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.code;
      opt.textContent = item.code + " - " + item.kelasLabel;
      classSelect.appendChild(opt);
    });
    if (prev && Array.from(classSelect.options).some(o => o.value === prev)) classSelect.value = prev;
  }

  function renderStudentsForClass(kelas) {
    studentsList.innerHTML = '';
    summaryBox.style.display = 'none';
    clearStatus();
    const names = classData[kelas] || [];
    if (!names.length) { studentsSection.style.display = 'none'; setStatus('Tiada senarai murid.', 'error'); return; }
    studentsSection.style.display = 'block';
    names.forEach((nama, idx) => {
      const row = document.createElement('div');
      row.className = 'student-row';
      row.dataset.name = (nama || '').toLowerCase();
      row.innerHTML = `<div>${idx + 1}</div><div class="student-name">${nama}</div><div class="checkbox-wrapper"><input type="checkbox" data-nama="${nama}" class="absent-checkbox"></div><div class="bersebab-wrapper hidden"><input type="checkbox" data-nama="${nama}" class="bersebab-checkbox"><label style="font-size:.75rem;">Ada sebab</label></div>`;
      studentsList.appendChild(row);

      // Toggle bersebab visibility when absent checkbox changes
      const absentChk = row.querySelector('.absent-checkbox');
      const bersebabWrapper = row.querySelector('.bersebab-wrapper');
      absentChk.addEventListener('change', () => {
        if (absentChk.checked) {
          bersebabWrapper.classList.remove('hidden');
        } else {
          bersebabWrapper.classList.add('hidden');
          const bersebabChk = bersebabWrapper.querySelector('.bersebab-checkbox');
          bersebabChk.checked = false;
        }
      });
    });
    countInfo.innerHTML = "üë• Jumlah murid: <strong>" + names.length + "</strong>";
    searchInput.value = '';
  }

  function getAbsentNames() {
    const arr = [];
    studentsList.querySelectorAll('.absent-checkbox').forEach(chk => { if (chk.checked) arr.push(chk.dataset.nama); });
    return arr;
  }

  function updateSummaryBox(kelas, absent) {
    const total = (classData[kelas] || []).length;
    const present = total - absent.length;
    summaryTitle.textContent = "Kehadiran hari ini (" + kelas + "):";
    summaryRatio.textContent = present + "/" + total + " hadir";
    summaryMini.textContent = "Tidak hadir: " + absent.length + " orang";
    if (absent.length > 0) {
      summaryAbsent.innerHTML = "Senarai murid tidak hadir:<ul>" + absent.map(n => "<li>" + n + "</li>").join('') + "</ul>";
    } else {
      summaryAbsent.textContent = "Semua murid hadir.";
    }
    summaryBox.style.display = 'block';
  }

  function applySearchFilter() {
    const q = searchInput.value.trim().toLowerCase();
    studentsList.querySelectorAll('.student-row').forEach(row => {
      row.style.display = (!q || (row.dataset.name || '').includes(q)) ? '' : 'none';
    });
  }
  searchInput.addEventListener('input', applySearchFilter);

  function saveAttendance() {
    // Check if today is a holiday
    if (isHoliday(todayKey)) {
      setStatus('Tidak boleh simpan kehadiran pada hari cuti sekolah.', 'error');
      return;
    }

    const kelas = classSelect.value;
    if (!kelas) { setStatus('Sila pilih kelas dahulu.', 'error'); return; }
    const names = classData[kelas] || [];
    if (!names.length) { setStatus('Tiada senarai murid.', 'error'); return; }

    const absentNames = getAbsentNames();
    const total = names.length;
    const present = total - absentNames.length;
    const meta = summaryConfig.find(x => x.code === kelas) || {};

    const data = {
      kodKelas: kelas,
      darjah: meta.darjah || '',
      kelasLabel: meta.kelasLabel || '',
      total: total,
      present: present,
      absentCount: absentNames.length,
      absentNames: absentNames,
      dateKey: todayKey,
      dateHuman: todayHuman,
      updatedAt: Date.now()
    };

    setStatus('Menyimpan kehadiran...', 'info');

    // Save attendance data first
    db.ref("kehadiran/" + todayKey + "/" + kelas).set(data).then(() => {
      // Save absence status for each absent student
      const statusPromises = [];
      studentsList.querySelectorAll('.student-row').forEach(row => {
        const absentChk = row.querySelector('.absent-checkbox');
        const bersebabChk = row.querySelector('.bersebab-checkbox');
        const nama = absentChk.dataset.nama;

        if (absentChk.checked) {
          const status = bersebabChk.checked ? 'bersebab' : 'tidak_bersebab';
          statusPromises.push(setAbsenceStatus(todayKey, kelas, nama, status));
        }
      });

      return Promise.all(statusPromises);
    }).then(() => {
      setStatus('Kehadiran berjaya disimpan.', '');
      updateSummaryBox(kelas, absentNames);
      loadDailySummary();
      loadWeeklySummary();
      loadMonthlySummary();
      yearlyRaw = null;
      yearlyInitialised = false;
      ensureYearlyData().then(() => recomputeNotificationsForYear(String(currentYear)));
    }).catch(err => {
      console.error(err);
      setStatus('Ralat: ' + err.message, 'error');
    });
  }

  function loadExistingAttendance(kelas) {
    db.ref("kehadiran/" + todayKey + "/" + kelas).once('value').then(snap => {
      const data = snap.val();

      // Reset all checkboxes and hide bersebab wrappers
      studentsList.querySelectorAll('.student-row').forEach(row => {
        const absentChk = row.querySelector('.absent-checkbox');
        const bersebabChk = row.querySelector('.bersebab-checkbox');
        const bersebabWrapper = row.querySelector('.bersebab-wrapper');
        absentChk.checked = false;
        bersebabChk.checked = false;
        bersebabWrapper.classList.add('hidden');
      });

      if (data?.absentNames) {
        // Check absent students and load their status
        studentsList.querySelectorAll('.student-row').forEach(row => {
          const absentChk = row.querySelector('.absent-checkbox');
          const bersebabChk = row.querySelector('.bersebab-checkbox');
          const bersebabWrapper = row.querySelector('.bersebab-wrapper');
          const nama = absentChk.dataset.nama;

          if (data.absentNames.includes(nama)) {
            absentChk.checked = true;
            bersebabWrapper.classList.remove('hidden');

            // Load absence status
            const status = getAbsenceStatus(todayKey, kelas, nama);
            if (status === 'bersebab') {
              bersebabChk.checked = true;
            }
          }
        });
        updateSummaryBox(kelas, data.absentNames);
      } else {
        summaryBox.style.display = 'none';
      }
    }).catch(err => { console.error(err); setStatus('Gagal memuatkan rekod.', 'error'); });
  }

  // Daily summary
  function loadDailySummary() {
    db.ref("kehadiran/" + todayKey).once('value').then(snap => {
      const all = snap.val() || {};
      summaryTableBody.innerHTML = '';
      let totalPresent = 0, totalStudents = 0, bil = 1;
      summaryConfig.forEach(cfg => {
        const rec = all[cfg.code];
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        let c4Content = '';
        let c4Class = 'main-row-cell';
        if (rec) {
          const p = rec.present || 0;
          const t = rec.total || 0;
          const ratio = p + "/" + t;
          if (rec.absentCount > 0 && rec.absentNames?.length) {
            c4Content = `<span class="attendance-link" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">${ratio}</span><div style="display:none;font-size:.8rem;color:#b45309;margin-top:4px;">Tidak hadir: ${rec.absentNames.map((n,i)=> (i+1)+') '+n).join('<br>')}</div>`;
          } else {
            c4Content = ratio;
            // Full attendance - green background
            if (p === t && t > 0) {
              c4Class += ' cell-full-attendance';
            }
          }
          totalPresent += p;
          totalStudents += t;
        } else {
          tr.classList.add('row-not-updated');
          c4Content = '<span class="cell-not-updated">Belum dikemaskini</span>';
        }
        tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell darjah-col">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td><td class="${c4Class}">${c4Content}</td>`;
        summaryTableBody.appendChild(tr);
      });
      if (totalStudents > 0) {
        const pct = (totalPresent / totalStudents) * 100;
        summaryFooter.innerHTML = "Kehadiran: " + totalPresent + "/" + totalStudents + " | Peratus: " + pct.toFixed(1) + "%";
      } else {
        summaryFooter.innerHTML = "Tiada rekod kehadiran.";
      }
    }).catch(err => { console.error(err); summaryFooter.innerHTML = "Ralat memuatkan data."; });
  }

  // Weekly summary
  function getWeekDates(baseDate) {
    const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
    const day = d.getDay();
    const diffToMonday = (day + 6) % 7;
    const monday = new Date(d);
    monday.setDate(d.getDate() - diffToMonday);
    const arr = [];
    for (let i = 0; i < 5; i++) {
      const tmp = new Date(monday);
      tmp.setDate(monday.getDate() + i);
      arr.push(tmp);
    }
    return arr;
  }

  function loadWeeklySummary() {
    const weekDates = getWeekDates(today);
    if (!weekDates.length) return;
    weeklyRangeLabel.textContent = formatShortDM(weekDates[0]) + " - " + formatShortDM(weekDates[weekDates.length - 1]);
    weeklyDateRow.innerHTML = '';
    const dateKeys = weekDates.map(dt => { weeklyDateRow.innerHTML += `<th>${formatShortDM(dt)}</th>`; return formatDateKey(dt); });
    weeklyHeaderSpan.colSpan = dateKeys.length;
    Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
      const allByDate = {};
      snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
      weeklyTableBody.innerHTML = '';
      let bil = 1;
      summaryConfig.forEach(cfg => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell darjah-col">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
        dateKeys.forEach(k => {
          const rec = allByDate[k]?.[cfg.code];
          const td = document.createElement('td');
          td.className = 'main-row-cell';

          // Check if this date is a holiday or weekend
          if(isHoliday(k) || isWeekend(k)) {
            td.textContent = '-';
            td.style.background = '#e5e7eb';
            td.style.color = '#9ca3af';
            td.style.fontWeight = '400';
            td.style.textAlign = 'center';
          } else if(rec){
            const p = (rec.present || 0);
            const t = (rec.total || 0);
            const absentNames = rec.absentNames || [];
            const absentArr = Array.isArray(absentNames) ? absentNames : Object.values(absentNames || {});
            if(p < t && absentArr.length > 0){
              const escapedNames = JSON.stringify(absentArr).replace(/'/g, "\\'").replace(/"/g, '&quot;');
              td.innerHTML = `<span class="attendance-link" data-absent="${escapedNames}" onclick="showAbsentDropdown(this)">${p}/${t}</span>`;
            } else {
              td.textContent = `${p}/${t}`;
              // Full attendance - green background
              if (p === t && t > 0) {
                td.classList.add('cell-full-attendance');
              }
            }
          } else {
            td.textContent = '-';
            td.style.color = '#9ca3af';
          }
          tr.appendChild(td);
        });
        weeklyTableBody.appendChild(tr);
      });
      weeklyInfo.textContent = 'Data minggu ' + weeklyRangeLabel.textContent;
    }).catch(err => { console.error(err); weeklyInfo.textContent = 'Ralat: ' + err.message; });
  }

  // Monthly summary
  function getMonthDates(baseDate) {
    const y = baseDate.getFullYear();
    const m = baseDate.getMonth();
    const daysInMonth = new Date(y, m + 1, 0).getDate();
    const arr = [];
    for (let d = 1; d <= daysInMonth; d++) arr.push(new Date(y, m, d));
    return arr;
  }

  function loadMonthlySummary() {
    const monthDates = getMonthDates(today);
    if (!monthDates.length) return;
    monthlyLabel.textContent = MONTH_NAMES_MS[today.getMonth()] + " " + today.getFullYear();
    monthlyDateRow.innerHTML = '';
    const dateKeys = monthDates.map(dt => { monthlyDateRow.innerHTML += `<th>${dt.getDate()}</th>`; return formatDateKey(dt); });
    monthlyHeaderSpan.colSpan = dateKeys.length;
    Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
      const allByDate = {};
      snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
      monthlyTableBody.innerHTML = '';
      let bil = 1;
      summaryConfig.forEach(cfg => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell darjah-col">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
        dateKeys.forEach(k => {
          const rec = allByDate[k]?.[cfg.code];
          const td = document.createElement('td');
          td.className = 'main-row-cell';

          // Check if this date is a holiday or weekend
          if(isHoliday(k) || isWeekend(k)) {
            td.textContent = '-';
            td.style.background = '#e5e7eb';
            td.style.color = '#9ca3af';
            td.style.fontWeight = '400';
            td.style.textAlign = 'center';
          } else if(rec){
            const p = (rec.present || 0);
            const t = (rec.total || 0);
            const absentNames = rec.absentNames || [];
            const absentArr = Array.isArray(absentNames) ? absentNames : Object.values(absentNames || {});
            if(p < t && absentArr.length > 0){
              const escapedNames = JSON.stringify(absentArr).replace(/'/g, "\\'").replace(/"/g, '&quot;');
              td.innerHTML = `<span class="attendance-link" data-absent="${escapedNames}" onclick="showAbsentDropdown(this)">${p}/${t}</span>`;
            } else {
              td.textContent = `${p}/${t}`;
              // Full attendance - green background
              if (p === t && t > 0) {
                td.classList.add('cell-full-attendance');
              }
            }
          } else {
            td.textContent = '-';
            td.style.color = '#9ca3af';
          }
          tr.appendChild(td);
        });
        monthlyTableBody.appendChild(tr);
      });
      monthlyInfo.textContent = 'Ringkasan untuk ' + monthlyLabel.textContent;
    }).catch(err => { console.error(err); monthlyInfo.textContent = 'Ralat: ' + err.message; });
  }

  // Yearly summary & notifications
  let yearlyRaw = null;
  let yearlyYears = [];
  let yearlyInitialised = false;
  let notifications = [];

  function renderNotificationBadge() {
    if (!notificationBadge) return;
    const count = notifications.length;
    if (count > 0) {
      notificationBadge.textContent = count > 99 ? '99+' : String(count);
      notificationBadge.style.display = 'flex';
    } else {
      notificationBadge.style.display = 'none';
    }
  }

  function renderAdminNotifications(yearStr) {
    if (!adminNotificationBody || !adminNotificationInfo) return;
    adminNotificationBody.innerHTML = '';
    if (!notifications.length) {
      adminNotificationInfo.textContent = 'Tiada murid ponteng (tidak bersebab) yang melepasi had tahun ' + yearStr + '.';
      return;
    }

    const severityRank = { 'Amaran Pertama': 1, 'Amaran Kedua': 2, 'Amaran Terakhir': 3, 'Buang Sekolah': 4 };
    notifications.sort((a, b) => {
      if (severityRank[b.letter] !== severityRank[a.letter]) return severityRank[b.letter] - severityRank[a.letter];
      if (a.classCode !== b.classCode) return a.classCode.localeCompare(b.classCode);
      return a.name.localeCompare(b.name);
    });

    notifications.forEach((n, idx) => {
      const tr = document.createElement('tr');
      tr.className = 'notification-row';
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${n.name}</td>
        <td>${n.classCode}</td>
        <td><strong>${n.totalPonteng}</strong> hari</td>
        <td>${n.mode === 'berturut-turut' ? 'Berturut-turut (' + n.consecutiveMax + ' hari)' : 'Berselang'}</td>
        <td><span class="${n.letter === 'Buang Sekolah' ? 'status-tidak-bersebab' : 'status-bersebab'}">${n.letter}</span></td>
      `;
      adminNotificationBody.appendChild(tr);
    });

    adminNotificationInfo.textContent = 'Senarai murid yang melepasi had ponteng (tidak bersebab) tahun ' + yearStr + '.';
  }

  function recomputeNotificationsForYear(yearStr) {
    notifications = [];
    if (!yearlyRaw) { renderNotificationBadge(); renderAdminNotifications(yearStr); return; }

    const stats = {};
    const dateKeys = Object.keys(yearlyRaw).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k) && k.slice(0, 4) === yearStr).sort();

    dateKeys.forEach(dateKey => {
      // Skip Sabtu, Ahad dan cuti sekolah
      if (!isSchoolDay(dateKey)) return;
      
      const dayObj = yearlyRaw[dateKey] || {};
      Object.keys(dayObj).forEach(classCode => {
        const rec = dayObj[classCode];
        if (!rec?.absentNames) return;
        rec.absentNames.forEach(name => {
          const status = getAbsenceStatus(dateKey, classCode, name);
          if (status !== 'tidak_bersebab') return; // Only count ponteng (tidak bersebab)
          
          const key = classCode + '|' + name;
          if (!stats[key]) stats[key] = { name, classCode, totalPonteng: 0, dates: [] };
          stats[key].totalPonteng++;
          stats[key].dates.push(dateFromKey(dateKey));
        });
      });
    });

    // Calculate consecutive days (skip weekends and holidays in between)
    Object.values(stats).forEach(stat => {
      stat.dates.sort((a, b) => a - b);
      let currentSeq = 0, maxSeq = 0, prevDate = null;
      
      stat.dates.forEach(d => {
        if (!prevDate) { 
          currentSeq = 1; 
        } else {
          // Count school days between prevDate and d
          let schoolDaysBetween = 0;
          let checkDate = new Date(prevDate);
          checkDate.setDate(checkDate.getDate() + 1);
          
          while (checkDate < d) {
            const checkKey = formatDateKey(checkDate);
            if (isSchoolDay(checkKey)) {
              schoolDaysBetween++;
            }
            checkDate.setDate(checkDate.getDate() + 1);
          }
          
          // If no school days between, it's consecutive
          currentSeq = schoolDaysBetween === 0 ? currentSeq + 1 : 1;
        }
        if (currentSeq > maxSeq) maxSeq = currentSeq;
        prevDate = d;
      });
      stat.consecutiveMax = maxSeq;
    });

    const consLevels = [{ threshold: 31, letter: 'Buang Sekolah' }, { threshold: 17, letter: 'Amaran Terakhir' }, { threshold: 10, letter: 'Amaran Kedua' }, { threshold: 3, letter: 'Amaran Pertama' }];
    const nonLevels = [{ threshold: 60, letter: 'Buang Sekolah' }, { threshold: 40, letter: 'Amaran Terakhir' }, { threshold: 20, letter: 'Amaran Kedua' }, { threshold: 10, letter: 'Amaran Pertama' }];
    const rank = { 'Amaran Pertama': 1, 'Amaran Kedua': 2, 'Amaran Terakhir': 3, 'Buang Sekolah': 4 };

    Object.values(stats).forEach(stat => {
      let consSuggest = null, nonSuggest = null;
      for (const lvl of consLevels) if (stat.consecutiveMax >= lvl.threshold) { consSuggest = { letter: lvl.letter, mode: 'berturut-turut' }; break; }
      for (const lvl of nonLevels) if (stat.totalPonteng >= lvl.threshold) { nonSuggest = { letter: lvl.letter, mode: 'berselang' }; break; }
      
      let chosen = null;
      if (consSuggest && nonSuggest) chosen = rank[consSuggest.letter] >= rank[nonSuggest.letter] ? consSuggest : nonSuggest;
      else chosen = consSuggest || nonSuggest;
      
      if (chosen) {
        notifications.push({
          name: stat.name,
          classCode: stat.classCode,
          letter: chosen.letter,
          mode: chosen.mode,
          totalPonteng: stat.totalPonteng,
          consecutiveMax: stat.consecutiveMax
        });
      }
    });

    renderNotificationBadge();
    renderAdminNotifications(yearStr);
  }

  function ensureYearlyData() {
    if (yearlyRaw) return Promise.resolve();
    return db.ref('kehadiran').once('value').then(snap => {
      yearlyRaw = snap.val() || {};
      const yearSet = new Set();
      Object.keys(yearlyRaw).forEach(k => { if (/^\d{4}-\d{2}-\d{2}$/.test(k)) yearSet.add(k.slice(0, 4)); });
      yearlyYears = Array.from(yearSet).sort();
    }).catch(err => console.error('Ralat memuatkan data tahunan:', err));
  }

  function populateYearlyYearOptions() {
    yearlyYearSelect.innerHTML = '';
    if (!yearlyYears.length) { yearlyYearSelect.innerHTML = '<option value="">Tiada tahun</option>'; return; }
    yearlyYears.forEach(y => { yearlyYearSelect.innerHTML += `<option value="${y}">${y}</option>`; });
  }

  function renderYearly(year) {
    yearlyTableBody.innerHTML = '';
    if (!year) { yearlyInfo.textContent = 'Tiada rekod.'; return; }
    const monthlyPresent = new Array(12).fill(0);
    const monthlyTotal = new Array(12).fill(0);

    Object.keys(yearlyRaw).forEach(dateKey => {
      if (dateKey.slice(0, 4) !== year) return;
      const mIdx = parseInt(dateKey.slice(5, 7), 10) - 1;
      if (mIdx < 0 || mIdx > 11) return;
      const dayData = yearlyRaw[dateKey] || {};
      Object.values(dayData).forEach(rec => {
        if (!rec || typeof rec.present !== 'number' || typeof rec.total !== 'number') return;
        monthlyPresent[mIdx] += rec.present;
        monthlyTotal[mIdx] += rec.total;
      });
    });

    let anyData = false, bil = 1;
    for (let i = 0; i < 12; i++) {
      const present = monthlyPresent[i], total = monthlyTotal[i];
      if (total > 0) anyData = true;
      const tr = document.createElement('tr');
      let c3 = total > 0 ? present + "/" + total + " (" + (present / total * 100).toFixed(1) + "%)" : '-';
      tr.innerHTML = `<td>${bil++}</td><td>${MONTH_NAMES_MS[i]}</td><td style="${total === 0 ? 'color:#9ca3af' : ''}">${c3}</td>`;
      yearlyTableBody.appendChild(tr);
    }
    yearlyInfo.textContent = anyData ? 'Ringkasan kehadiran bagi tahun ' + year + '.' : 'Tiada rekod.';
  }

  function initYearlySummary() {
    ensureYearlyData().then(() => {
      populateYearlyYearOptions();
      let defaultYear = String(currentYear);
      if (!yearlyYears.includes(defaultYear) && yearlyYears.length) defaultYear = yearlyYears[0];
      yearlyYearSelect.value = defaultYear;
      renderYearly(yearlyYearSelect.value);
      yearlyInitialised = true;
    });
  }

  if (yearlyYearSelect) yearlyYearSelect.addEventListener('change', () => { if (yearlyRaw) renderYearly(yearlyYearSelect.value); });

  // Admin class table
  function renderAdminClassTable() {
    if (!adminClassTableBody) return;
    adminClassTableBody.innerHTML = '';
    let bil = 1;
    summaryConfig.forEach(cfg => {
      const list = classData[cfg.code] || [];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${bil++}</td><td>${cfg.darjah}</td><td>${cfg.code}</td><td>${cfg.kelasLabel}</td><td>${list.length}</td><td><button class="btn btn-danger btn-sm admin-delete-class" data-code="${cfg.code}">Padam</button></td>`;
      adminClassTableBody.appendChild(tr);
    });
  }

  adminClassTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('.admin-delete-class');
    if (!btn) return;
    const code = btn.dataset.code;
    if (!confirm('Padam kelas ' + code + '?')) return;
    const cfgIndex = summaryConfig.findIndex(c => c.code === code);
    if (cfgIndex !== -1) summaryConfig.splice(cfgIndex, 1);
    if (classData[code]) delete classData[code];
    saveClassConfigToDB();
    renderAdminClassTable();
    populateClassDropdown();
    populateAdminClassSelect();
    populateStatusClassSelect();
    if (classSelect.value === code) { classSelect.value = ''; studentsSection.style.display = 'none'; summaryBox.style.display = 'none'; }
    adminClassMsg.textContent = 'Kelas ' + code + ' telah dipadam.';
    adminClassMsg.style.color = '#b91c1c';
  });

  function populateAdminClassSelect() {
    if (!adminStudentClassSelect) return;
    const prev = adminStudentClassSelect.value;
    adminStudentClassSelect.innerHTML = '<option value="">‚Äî Pilih kelas ‚Äî</option>';
    summaryConfig.forEach(cfg => { adminStudentClassSelect.innerHTML += `<option value="${cfg.code}">${cfg.code} - ${cfg.kelasLabel}</option>`; });
    if (prev && Array.from(adminStudentClassSelect.options).some(o => o.value === prev)) adminStudentClassSelect.value = prev;
    loadAdminStudentsForClass();
  }

  function loadAdminStudentsForClass() {
    const code = adminStudentClassSelect.value;
    if (!code) { adminStudentTextarea.value = ''; adminStudentCount.textContent = 'Bil. murid: 0'; return; }
    const list = classData[code] || [];
    adminStudentTextarea.value = list.join("\n");
    adminStudentCount.textContent = 'Bil. murid: ' + list.length;
  }

  function handleAdminSaveStudents() {
    const code = adminStudentClassSelect.value;
    if (!code) { adminStudentMsg.textContent = 'Sila pilih kelas dahulu.'; adminStudentMsg.style.color = '#b91c1c'; return; }
    const lines = adminStudentTextarea.value.split(/\r?\n/).map(x => x.trim()).filter(x => x.length > 0);
    classData[code] = lines;
    adminStudentCount.textContent = 'Bil. murid: ' + lines.length;
    adminStudentMsg.textContent = 'Menyimpan ke Firebase...';
    adminStudentMsg.style.color = '#0369a1';
    saveClassConfigToDB().then(() => {
      adminStudentMsg.textContent = 'Senarai murid berjaya disimpan ke Firebase!';
      adminStudentMsg.style.color = '#047857';
      renderAdminClassTable();
      populateClassDropdown();
    });
  }

  function handleAdminAddClass() {
    const darjah = adminNewDarjah.value.trim().toUpperCase();
    const code = adminNewCode.value.trim().toUpperCase();
    const label = adminNewLabel.value.trim().toUpperCase();
    if (!darjah || !code || !label) { adminClassMsg.textContent = 'Sila isi semua ruangan.'; adminClassMsg.style.color = '#b91c1c'; return; }
    if (classData[code]) { adminClassMsg.textContent = 'Kod kelas sudah wujud.'; adminClassMsg.style.color = '#b91c1c'; return; }
    classData[code] = [];
    summaryConfig.push({ darjah, kelasLabel: label, code });
    
    // Sort selepas tambah kelas baharu
    sortSummaryConfig();
    
    adminNewDarjah.value = '';
    adminNewCode.value = '';
    adminNewLabel.value = '';
    adminClassMsg.textContent = 'Menyimpan ke Firebase...';
    adminClassMsg.style.color = '#0369a1';
    saveClassConfigToDB().then(() => {
      adminClassMsg.textContent = 'Kelas baharu ditambah dan disimpan ke Firebase!';
      adminClassMsg.style.color = '#047857';
      renderAdminClassTable();
      populateClassDropdown();
      populateAdminClassSelect();
      populateStatusClassSelect();
    });
  }

  adminStudentClassSelect.addEventListener('change', loadAdminStudentsForClass);
  adminSaveStudentsBtn.addEventListener('click', handleAdminSaveStudents);
  adminAddClassBtn.addEventListener('click', handleAdminAddClass);
  adminStudentTextarea.addEventListener('input', () => {
    const lines = adminStudentTextarea.value.split(/\r?\n/).map(x => x.trim()).filter(x => x.length > 0);
    adminStudentCount.textContent = 'Bil. murid: ' + lines.length;
  });

  // Event handlers
  classSelect.addEventListener('change', () => {
    const kelas = classSelect.value;
    if (!kelas) { studentsSection.style.display = 'none'; summaryBox.style.display = 'none'; clearStatus(); return; }

    // Check if today is a holiday and show warning
    if (isHoliday(todayKey)) {
      setStatus('‚ö†Ô∏è Hari ini adalah cuti sekolah. Kehadiran tidak boleh direkod.', 'error');
    }

    renderStudentsForClass(kelas);
    loadExistingAttendance(kelas);
  });

  btnSave.addEventListener('click', saveAttendance);
  btnAllPresent.addEventListener('click', () => {
    studentsList.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = false);
    setStatus('Semua hadir.', 'info');
    summaryBox.style.display = 'none';
  });
  btnClearTicks.addEventListener('click', () => {
    studentsList.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = false);
    setStatus('Tanda dikosongkan.', 'info');
    summaryBox.style.display = 'none';
  });

  // ============ Admin Function Dropdown Handler ============
  const adminFunctionSelect = document.getElementById('adminFunctionSelect');
  const adminPanels = document.querySelectorAll('.admin-panel');
  
  if (adminFunctionSelect) {
    adminFunctionSelect.addEventListener('change', () => {
      const selected = adminFunctionSelect.value;
      // Hide all panels
      adminPanels.forEach(panel => panel.style.display = 'none');
      // Show selected panel
      if (selected) {
        const panel = document.getElementById('adminPanel-' + selected);
        if (panel) {
          panel.style.display = 'block';
          // Trigger specific panel init if needed
          if (selected === 'holidaySettings') {
            renderHolidayCalendar();
          } else if (selected === 'absenceChecker') {
            initAbsenceChecker();
          } else if (selected === 'pontengNotif') {
            recomputeNotificationsForYear(String(currentYear));
          }
        }
      }
    });
  }

  // ============ Absence Checker Functions ============
  const absenceReportType = document.getElementById('absenceReportType');
  const absenceMonthSelect = document.getElementById('absenceMonthSelect');
  const absenceMonthSelectWrapper = document.getElementById('absenceMonthSelectWrapper');
  const loadAbsenceReportBtn = document.getElementById('loadAbsenceReportBtn');
  const absenceReportResult = document.getElementById('absenceReportResult');

  function initAbsenceChecker() {
    // Populate month select
    if (absenceMonthSelect) {
      absenceMonthSelect.innerHTML = '';
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = MONTH_NAMES_MS[m] + ' ' + currentYear;
        if (m === today.getMonth()) opt.selected = true;
        absenceMonthSelect.appendChild(opt);
      }
    }
    // Show/hide month select based on report type
    if (absenceReportType) {
      absenceReportType.addEventListener('change', () => {
        absenceMonthSelectWrapper.style.display = absenceReportType.value === 'monthly' ? 'block' : 'none';
      });
    }
  }

  if (loadAbsenceReportBtn) {
    loadAbsenceReportBtn.addEventListener('click', generateAbsenceReport);
  }

  async function generateAbsenceReport() {
    if (!absenceReportResult) return;
    absenceReportResult.innerHTML = '<div style="text-align:center;padding:20px;color:#6b7280;">‚è≥ Memuatkan data...</div>';
    
    const reportType = absenceReportType?.value || 'monthly';
    const selectedMonth = parseInt(absenceMonthSelect?.value || today.getMonth());
    
    try {
      // Fetch all attendance data for the year
      const snap = await db.ref('kehadiran').once('value');
      const allData = snap.val() || {};
      
      // Build absence map: { studentName: { class, dates: [], count } }
      const absenceMap = {};
      
      Object.keys(allData).forEach(dateKey => {
        const dateObj = new Date(dateKey);
        const isValidDate = reportType === 'yearly' || dateObj.getMonth() === selectedMonth;
        
        if (!isValidDate) return;
        
        const dayData = allData[dateKey];
        Object.keys(dayData).forEach(classCode => {
          const rec = dayData[classCode];
          const absentNames = rec.absentNames || [];
          const absentArr = Array.isArray(absentNames) ? absentNames : Object.values(absentNames || {});
          
          absentArr.forEach(name => {
            if (!name) return;
            const key = name + '|' + classCode;
            if (!absenceMap[key]) {
              absenceMap[key] = {
                name: name,
                classCode: classCode,
                classLabel: summaryConfig.find(c => c.code === classCode)?.kelasLabel || classCode,
                darjah: summaryConfig.find(c => c.code === classCode)?.darjah || '',
                dates: [],
                count: 0
              };
            }
            absenceMap[key].dates.push(dateKey);
            absenceMap[key].count++;
          });
        });
      });
      
      // Convert to array and sort by count (highest first)
      const absenceList = Object.values(absenceMap).sort((a, b) => b.count - a.count);
      
      if (absenceList.length === 0) {
        absenceReportResult.innerHTML = `
          <div style="text-align:center;padding:30px;background:#d1fae5;border-radius:12px;color:#047857;">
            <div style="font-size:2rem;margin-bottom:8px;">üéâ</div>
            <strong>Tiada rekod ketidakhadiran untuk tempoh ini!</strong>
          </div>
        `;
        return;
      }
      
      // Generate report HTML
      const periodLabel = reportType === 'yearly' 
        ? 'Tahun ' + currentYear 
        : MONTH_NAMES_MS[selectedMonth] + ' ' + currentYear;
      
      let html = `
        <div style="margin-bottom:12px;">
          <strong>Laporan Ketidakhadiran: ${periodLabel}</strong>
          <span class="pill" style="margin-left:8px;">${absenceList.length} murid</span>
        </div>
      `;

      absenceList.forEach((item, idx) => {
        // Generate date items with status toggle
        const dateItems = item.dates.sort().map(dateKey => {
          const dt = new Date(dateKey);
          const dateLabel = dt.getDate() + '/' + (dt.getMonth() + 1);
          const status = getAbsenceStatus(dateKey, item.classCode, item.name);
          const statusClass = status === 'bersebab' ? 'bersebab' : 'tidak_bersebab';
          const statusText = status === 'bersebab' ? 'Bersebab' : 'Tidak Bersebab';

          // Use data attributes instead of inline onclick to avoid escaping issues
          const safeName = item.name.replace(/"/g, '&quot;');
          return `
            <div class="absence-date-item">
              <span class="absence-date-label">${dateLabel}</span>
              <button class="absence-status-toggle ${statusClass}"
                      data-date="${dateKey}"
                      data-class="${item.classCode}"
                      data-student="${safeName}">
                ${statusText}
              </button>
            </div>
          `;
        }).join('');

        html += `
          <div class="absence-card">
            <div class="absence-card-header" onclick="this.parentElement.querySelector('.absence-card-dates').classList.toggle('show')">
              <div>
                <div class="absence-card-name">${idx + 1}. ${item.name}</div>
                <div class="absence-card-class">${item.darjah} ${item.classLabel} (${item.classCode})</div>
              </div>
              <div class="absence-card-count">${item.count} hari</div>
            </div>
            <div class="absence-card-dates">
              <strong style="display:block;margin-bottom:8px;">Tarikh tidak hadir:</strong>
              ${dateItems}
            </div>
          </div>
        `;
      });

      absenceReportResult.innerHTML = html;

      // Attach click event listeners to all toggle buttons
      document.querySelectorAll('.absence-status-toggle').forEach(button => {
        button.addEventListener('click', function(event) {
          event.stopPropagation(); // Prevent card from collapsing
          const dateKey = this.getAttribute('data-date');
          const classCode = this.getAttribute('data-class');
          const studentName = this.getAttribute('data-student');
          toggleAbsenceStatus(dateKey, classCode, studentName, this);
        });
      });

      
    } catch (err) {
      console.error('Error generating absence report:', err);
      absenceReportResult.innerHTML = '<div style="color:#b91c1c;padding:20px;">‚ùå Ralat: ' + err.message + '</div>';
    }
  }

  // Toggle absence status for a specific date
  function toggleAbsenceStatus(dateKey, classCode, studentName, buttonEl) {
    const currentStatus = getAbsenceStatus(dateKey, classCode, studentName);
    const newStatus = currentStatus === 'bersebab' ? 'tidak_bersebab' : 'bersebab';

    // Update button UI immediately for better UX
    buttonEl.disabled = true;
    buttonEl.style.opacity = '0.5';

    setAbsenceStatus(dateKey, classCode, studentName, newStatus).then(() => {
      // Update button classes and text
      buttonEl.classList.remove('bersebab', 'tidak_bersebab');
      buttonEl.classList.add(newStatus);
      buttonEl.textContent = newStatus === 'bersebab' ? 'Bersebab' : 'Tidak Bersebab';
      buttonEl.disabled = false;
      buttonEl.style.opacity = '1';

      // Recompute notifications after status change
      yearlyRaw = null;
      yearlyInitialised = false;
      ensureYearlyData().then(() => recomputeNotificationsForYear(String(currentYear)));
    }).catch(err => {
      console.error('Error toggling absence status:', err);
      alert('Gagal menukar status: ' + err.message);
      buttonEl.disabled = false;
      buttonEl.style.opacity = '1';
    });
  }

  // Init
  function initApp() {
    populateClassDropdown();
    renderAdminClassTable();
    populateAdminClassSelect();
    initAbsenceChecker();

    // Load holidays first, then load summaries and other data
    loadHolidays().then(() => {
      updateDateDisplayWithHolidayCheck();
      // Load summaries after holidays are loaded so holiday check works
      loadDailySummary();
      loadWeeklySummary();
      loadMonthlySummary();
      renderHolidayCalendar();
      ensureYearlyData().then(() => {
        loadAbsenceStatus().then(() => {
          recomputeNotificationsForYear(String(currentYear));
        });
      });
    });
  }

  loadClassConfigFromDB().then(initApp).catch(err => { console.error(err); initApp(); });

  // ============ PWA Service Worker & Install Prompt ============

  // Unregister any existing service workers
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister().then(() => console.log('Service Worker unregistered'));
      });
    });
  }

  // Install Prompt
  let deferredPrompt;
  const installBanner = document.createElement('div');
  installBanner.id = 'installBanner';
  installBanner.innerHTML = `
    <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;padding:12px 20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;z-index:100;max-width:90%;font-size:.9rem;">
      <span>üì± Install app ini ke peranti anda!</span>
      <button id="installBtn" style="background:#fff;color:#1d4ed8;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Install</button>
      <button id="dismissBtn" style="background:transparent;color:#fff;border:1px solid #fff;padding:8px 12px;border-radius:8px;cursor:pointer;">Nanti</button>
    </div>
  `;
  installBanner.style.display = 'none';
  document.body.appendChild(installBanner);

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBanner.style.display = 'block';
  });

  document.getElementById('installBtn').addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('Install prompt outcome:', outcome);
      deferredPrompt = null;
      installBanner.style.display = 'none';
    }
  });

  document.getElementById('dismissBtn').addEventListener('click', () => {
    installBanner.style.display = 'none';
  });

  window.addEventListener('appinstalled', () => {
    console.log('App berjaya diinstall!');
    installBanner.style.display = 'none';
  });

})();

// ================= Matrix Cuti Table (Option 1) =================
let matrixYear = new Date().getFullYear();
let matrixMonth = new Date().getMonth();

function daysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}

function formatYM(y, m) {
  return MONTH_NAMES_MS[m] + ' ' + y;
}

function buildMatrixHeader(y, m) {
  const totalDays = daysInMonth(y, m);
  let ths = '<th style="position:sticky;left:0;background:#e5f0ff;z-index:3;">Kelas</th>';
  for (let d = 1; d <= totalDays; d++) {
    const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const dt = new Date(y, m, d);
    const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
    const isHolidayDay = holidaysCache[dateKey];
    let style = 'cursor:pointer;';
    if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;cursor:default;';
    if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
    ths += `<th style="${style}" ${!isWeekendDay ? `onclick="toggleMatrixHoliday('${dateKey}')"` : ''} title="${isWeekendDay?'Hujung minggu':(isHolidayDay?'Cuti - klik untuk batalkan':'Klik untuk tandakan cuti')}">${d}</th>`;
  }
  return ths;
}

function buildMatrixRows(y, m, allByDate) {
  const totalDays = daysInMonth(y, m);
  let rows = '';
  summaryConfig.forEach(cfg => {
    rows += `<tr><td style="position:sticky;left:0;background:#fff;font-weight:600;z-index:2;">${cfg.code} - ${cfg.kelasLabel}</td>`;
    for (let d = 1; d <= totalDays; d++) {
      const dateKey = y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      const dt = new Date(y, m, d);
      const isWeekendDay = dt.getDay() === 0 || dt.getDay() === 6;
      const isHolidayDay = holidaysCache[dateKey];
      const rec = allByDate[dateKey]?.[cfg.code];
      let content = '-';
      let style = 'text-align:center;';
      if (isWeekendDay) style += 'background:#f3f4f6;color:#9ca3af;';
      if (isHolidayDay) style += 'background:#fecaca;color:#b91c1c;';
      if (rec && !isWeekendDay && !isHolidayDay) content = (rec.present||0) + '/' + (rec.total||0);
      rows += `<td style="${style}">${content}</td>`;
    }
    rows += '</tr>';
  });
  return rows;
}

function renderMatrixCuti() {
  if (!isAdmin) return;
  const container = document.getElementById('matrixCutiContainer');
  if (!container) return;
  const y = matrixYear, m = matrixMonth;
  const totalDays = daysInMonth(y, m);
  const monthLabel = formatYM(y, m);
  container.innerHTML = `
    <div class="summary-header-row" style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
      <strong>Jadual Cuti & Kehadiran (Matrix): ${monthLabel}</strong>
      <div style="display:flex;gap:6px;">
        <button type="button" class="btn btn-outline btn-sm" onclick="prevMatrixMonth()">‚óÄ</button>
        <button type="button" class="btn btn-outline btn-sm" onclick="nextMatrixMonth()">‚ñ∂</button>
      </div>
    </div>
    <div class="summary-table-wrapper" style="margin-top:8px;overflow:auto;">
      <table class="summary-table">
        <thead><tr id="matrixHeaderRow"></tr></thead>
        <tbody id="matrixBody"></tbody>
      </table>
    </div>
    <div class="summary-footer">Klik tarikh (header) untuk tandakan CUTI bagi semua kelas. Sabtu/Ahad auto cuti.</div>
  `;
  const headerRow = container.querySelector('#matrixHeaderRow');
  headerRow.innerHTML = buildMatrixHeader(y, m);

  const dateKeys = [];
  for (let d = 1; d <= totalDays; d++) {
    dateKeys.push(y + '-' + String(m+1).padStart(2,'0') + '-' + String(d).padStart(2,'0'));
  }
  Promise.all(dateKeys.map(k => db.ref('kehadiran/' + k).once('value'))).then(snaps => {
    const allByDate = {};
    snaps.forEach((snap, i) => { allByDate[dateKeys[i]] = snap.val() || {}; });
    const body = container.querySelector('#matrixBody');
    body.innerHTML = buildMatrixRows(y, m, allByDate);
  });
}

function toggleMatrixHoliday(dateKey) {
  toggleHoliday(dateKey).then(() => {
    renderMatrixCuti();
    loadMonthlySummary();
    loadWeeklySummary();
    loadDailySummary();
    recomputeNotificationsForYear(String(currentYear));
  });
}

function prevMatrixMonth() {
  matrixMonth--;
  if (matrixMonth < 0) { matrixMonth = 11; matrixYear--; }
  renderMatrixCuti();
}
function nextMatrixMonth() {
  matrixMonth++;
  if (matrixMonth > 11) { matrixMonth = 0; matrixYear++; }
  renderMatrixCuti();
}

// Hook render when admin tab is opened
const _origAdminTabHandler = document.getElementById('adminTabBtn');
if (_origAdminTabHandler) {
  _origAdminTabHandler.addEventListener('click', () => {
    loadHolidays().then(renderMatrixCuti);
  });
}


async function fetchAbsentListFromDaily(dateKey, classCode) {
  try {
    const database = window.db || (firebase && firebase.database && firebase.database());
    // Fetch the entire record to be safe
    const snap = await database.ref(`kehadiran/${dateKey}/${classCode}`).once('value');
    const record = snap.val();
    
    if (!record) {
      console.log('No record found for', dateKey, classCode);
      return [];
    }
    
    const absentNames = record.absentNames;
    
    // Handle various formats Firebase might return
    if (!absentNames) return [];
    if (Array.isArray(absentNames)) return absentNames.filter(n => n); // filter out nulls
    if (typeof absentNames === 'object') return Object.values(absentNames).filter(n => n);
    if (typeof absentNames === 'string') return [absentNames];
    
    return [];
  } catch (e) {
    console.error('Fetch absent error', e);
    return [];
  }
}

// Show absent dropdown using data attribute (no async fetch needed)
function showAbsentDropdown(el) {
  const existing = el.parentElement.querySelector('.absent-dropdown');
  if(existing){ existing.remove(); return; }
  
  // Get absent names from data attribute
  let names = [];
  try {
    const dataAttr = el.getAttribute('data-absent');
    if (dataAttr) {
      names = JSON.parse(dataAttr.replace(/&quot;/g, '"'));
    }
  } catch(e) {
    console.error('Error parsing absent names:', e);
  }
  
  const div = document.createElement('div');
  div.className = 'absent-dropdown';
  div.style.marginTop = '6px';
  div.style.padding = '8px';
  div.style.background = '#fef3c7';
  div.style.border = '1px solid #f59e0b';
  div.style.borderRadius = '8px';
  div.style.fontSize = '13px';
  div.style.position = 'relative';
  div.style.zIndex = '10';
  
  if(names.length > 0){
    div.innerHTML = '<strong style="color:#b45309;">Tidak hadir:</strong><br>' + names.map((n,i)=> `<span style="color:#78350f;">${i+1}) ${n}</span>`).join('<br>');
  } else {
    div.innerHTML = '<em>Tiada data.</em>';
  }
  
  el.parentElement.appendChild(div);
}

async function toggleAbsentListFromDaily(dateKey, classCode, el){
  const existing = el.parentElement.querySelector('.absent-dropdown');
  if(existing){ existing.remove(); return; }

  const names = await fetchAbsentListFromDaily(dateKey, classCode);

  const div = document.createElement('div');
  div.className = 'absent-dropdown';
  div.style.marginTop = '6px';
  div.style.padding = '8px';
  div.style.background = '#f9fafb';
  div.style.border = '1px solid #e5e7eb';
  div.style.borderRadius = '8px';
  div.style.fontSize = '13px';

  if(names.length > 0){
    div.innerHTML = '<strong>Tidak hadir:</strong><br>' + names.map((n,i)=> (i+1)+') '+n).join('<br>');
  } else {
    div.innerHTML = '<em>Tiada murid tidak hadir.</em>';
  }

  el.parentElement.appendChild(div);
}


/* =========================
   WEEKLY & MONTHLY SUMMARY (2B/5C KEYS ONLY)
   Clean standalone block ‚Äì no patching existing logic
   ========================= */

function _getWeekKeyFromDateKey(dateKey){
  const p = dateKey.split('-');
  const d = new Date(Date.UTC(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2])));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return d.getUTCFullYear() + '-W' + String(weekNo).padStart(2,'0');
}

function _getMonthKeyFromDateKey(dateKey){
  const p = dateKey.split('-');
  return p[0] + '-' + p[1];
}

function _upsertWeeklyMonthly_2B(dateKey, classKey, present, total, absentArr){
  const database = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(dateKey);
  const monthKey = _getMonthKeyFromDateKey(dateKey);
  const payloadForDay = {};
  payloadForDay[dateKey] = absentArr || [];

  const weekRef = database.ref('weeklySummary/' + weekKey + '/' + classKey);
  const monthRef = database.ref('monthlySummary/' + monthKey + '/' + classKey);

  weekRef.transaction(curr => {
    const next = curr ? Object.assign({}, curr) : { present: 0, total: 0, absent: {} };
    next.present = (next.present || 0) + (present || 0);
    next.total = (next.total || 0) + (total || 0);
    next.absent = Object.assign({}, next.absent || {}, payloadForDay);
    return next;
  });

  monthRef.transaction(curr => {
    const next = curr ? Object.assign({}, curr) : { present: 0, total: 0, absent: {} };
    next.present = (next.present || 0) + (present || 0);
    next.total = (next.total || 0) + (total || 0);
    next.absent = Object.assign({}, next.absent || {}, payloadForDay);
    return next;
  });
}

// Wrapper to call after daily save (safe)
function onDailySaved_2B(dateKey, classKey, payload){
  try{
    const present = payload.present || 0;
    const total = payload.total || 0;
    const absentArr = payload.absent || [];
    _upsertWeeklyMonthly_2B(dateKey, classKey, present, total, absentArr);
  }catch(e){ console.error('Weekly/Monthly upsert error', e); }
}

// Inline viewer for weekly/monthly
function showAbsentInline_2B(dateKey, classKey, el){
  const existing = el.parentElement.querySelector('.absent-dropdown');
  if(existing){ existing.remove(); return; }
  const database = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(dateKey);
  const monthKey = _getMonthKeyFromDateKey(dateKey);

  database.ref('weeklySummary/' + weekKey + '/' + classKey + '/absent/' + dateKey).once('value')
    .then(snap => {
      const v = snap.val();
      if(v) return v;
      return database.ref('monthlySummary/' + monthKey + '/' + classKey + '/absent/' + dateKey).once('value').then(s => s.val());
    })
    .then(val => {
      const names = Array.isArray(val) ? val : (val && typeof val === 'object' ? Object.values(val) : []);
      const div = document.createElement('div');
      div.className = 'absent-dropdown';
      div.style.marginTop = '6px';
      div.style.padding = '8px';
      div.style.background = '#f9fafb';
      div.style.border = '1px solid #e5e7eb';
      div.style.borderRadius = '8px';
      div.style.fontSize = '13px';
      if(names.length > 0){
        div.innerHTML = '<strong>Tidak hadir:</strong><br>' + names.map((n,i)=> (i+1)+') '+n).join('<br>');
      } else {
        div.innerHTML = '<em>Tiada murid tidak hadir.</em>';
      }
      el.parentElement.appendChild(div);
    })
    .catch(err => console.error(err));
}

// Load Weekly from Firebase (2B keys)
function loadWeeklySummary(){
  const weekDates = getWeekDates(today);
  if (!weekDates || !weekDates.length) return;
  weeklyRangeLabel.textContent = formatShortDM(weekDates[0]) + " - " + formatShortDM(weekDates[weekDates.length - 1]);
  weeklyDateRow.innerHTML = '';
  const dateKeys = weekDates.map(dt => { weeklyDateRow.innerHTML += `<th>${formatShortDM(dt)}</th>`; return formatDateKey(dt); });
  weeklyHeaderSpan.colSpan = dateKeys.length;
  weeklyTableBody.innerHTML = '';
  let bil = 1;

  const database = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(formatDateKey(weekDates[0]));

  database.ref('weeklySummary/' + weekKey).once('value').then(snap => {
    const data = snap.val() || {};
    summaryConfig.forEach(cfg => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
      const classKey = cfg.code; // 2B, 5C
      dateKeys.forEach(k => {
        const td = document.createElement('td');
        td.className = 'main-row-cell';
        const rec = data[classKey];
        if(rec && rec.absent && rec.absent[k]){
          const p = rec.present || 0;
          const t = rec.total || 0;
          if((rec.absent[k] || []).length > 0){
            td.innerHTML = `<span style="cursor:pointer;color:#2563eb;" onclick="showAbsentInline_2B('${k}','${classKey}', this)">${p}/${t}</span>`;
          } else {
            td.textContent = `${p}/${t}`;
          }
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
        tr.appendChild(td);
      });
      weeklyTableBody.appendChild(tr);
    });
    weeklyInfo.textContent = 'Data minggu ' + weeklyRangeLabel.textContent;
  }).catch(err => { console.error(err); weeklyInfo.textContent = 'Ralat: ' + err.message; });
}

// Load Monthly from Firebase (2B keys)
function loadMonthlySummary(){
  const monthDates = getMonthDates(today);
  const y = today.getFullYear();
  const m = today.getMonth();
  monthlyHeaderSpan.colSpan = monthDates.length;
  monthlyDateRow.innerHTML = '';
  monthDates.forEach(dt => monthlyDateRow.innerHTML += `<th>${dt.getDate()}</th>`);
  monthlyTableBody.innerHTML = '';
  let bil = 1;

  const database = window.db || firebase.database();
  const monthKey = _getMonthKeyFromDateKey(formatDateKey(monthDates[0]));

  database.ref('monthlySummary/' + monthKey).once('value').then(snap => {
    const data = snap.val() || {};
    summaryConfig.forEach(cfg => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
      const classKey = cfg.code; // 2B, 5C
      monthDates.forEach(dt => {
        const k = formatDateKey(dt);
        const td = document.createElement('td');
        td.className = 'main-row-cell';
        const rec = data[classKey];
        if(rec && rec.absent && rec.absent[k]){
          const p = rec.present || 0;
          const t = rec.total || 0;
          if((rec.absent[k] || []).length > 0){
            td.innerHTML = `<span style="cursor:pointer;color:#2563eb;" onclick="showAbsentInline_2B('${k}','${classKey}', this)">${p}/${t}</span>`;
          } else {
            td.textContent = `${p}/${t}`;
          }
        } else {
          td.textContent = '-';
          td.style.color = '#9ca3af';
        }
        tr.appendChild(td);
      });
      monthlyTableBody.appendChild(tr);
    });
    monthlyInfo.textContent = 'Data bulan ' + (m+1) + '/' + y;
  }).catch(err => { console.error(err); monthlyInfo.textContent = 'Ralat: ' + err.message; });
}


/* =========================
   WEEKLY & MONTHLY SUMMARY (2B/5C KEYS ONLY)
   FINAL STABLE VERSION ‚Äì standalone
   ========================= */

function _getWeekDates_2B(baseDate){
  const start = new Date(baseDate);
  start.setDate(start.getDate() - (start.getDay() || 7) + 1); // Monday
  const dates = [];
  for(let i=0;i<5;i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    dates.push(d);
  }
  return dates;
}

function _getMonthDates_2B(baseDate){
  const y = baseDate.getFullYear();
  const m = baseDate.getMonth();
  const last = new Date(y, m+1, 0).getDate();
  const dates = [];
  for(let i=1;i<=last;i++){
    dates.push(new Date(y, m, i));
  }
  return dates;
}

function _formatDateKey_2B(date){
  return date.toISOString().slice(0,10);
}

function _formatShortDM_2B(date){
  return date.getDate().toString().padStart(2,'0') + '/' + (date.getMonth()+1).toString().padStart(2,'0');
}

function _getWeekKeyFromDateKey(dateKey){
  const p = dateKey.split('-');
  const d = new Date(Date.UTC(p[0], p[1]-1, p[2]));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return d.getUTCFullYear() + '-W' + String(weekNo).padStart(2,'0');
}

function _getMonthKeyFromDateKey(dateKey){
  const p = dateKey.split('-');
  return p[0] + '-' + p[1];
}

function _upsertWeeklyMonthly_2B(dateKey, classKey, present, total, absentArr){
  const db = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(dateKey);
  const monthKey = _getMonthKeyFromDateKey(dateKey);
  const payload = {};
  payload[dateKey] = absentArr || [];

  db.ref('weeklySummary/'+weekKey+'/'+classKey).transaction(curr=>{
    const n = curr || {present:0,total:0,absent:{}};
    n.present += present || 0;
    n.total += total || 0;
    n.absent = Object.assign({}, n.absent, payload);
    return n;
  });

  db.ref('monthlySummary/'+monthKey+'/'+classKey).transaction(curr=>{
    const n = curr || {present:0,total:0,absent:{}};
    n.present += present || 0;
    n.total += total || 0;
    n.absent = Object.assign({}, n.absent, payload);
    return n;
  });
}

function onDailySaved_2B(dateKey, classKey, payload){
  _upsertWeeklyMonthly_2B(dateKey, classKey, payload.present || 0, payload.total || 0, payload.absent || []);
}

function loadWeeklySummary(){
  const weekDates = _getWeekDates_2B(today);
  const dateKeys = weekDates.map(d=>_formatDateKey_2B(d));

  weeklyRangeLabel.textContent = _formatShortDM_2B(weekDates[0])+" - "+_formatShortDM_2B(weekDates[weekDates.length-1]);
  weeklyDateRow.innerHTML = dateKeys.map(d=>`<th>${d.slice(8,10)}/${d.slice(5,7)}</th>`).join('');
  weeklyHeaderSpan.colSpan = dateKeys.length;
  weeklyTableBody.innerHTML = '';

  const db = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(dateKeys[0]);

  db.ref('weeklySummary/'+weekKey).once('value').then(snap=>{
    const data = snap.val() || {};
    let bil = 1;
    summaryConfig.forEach(cfg=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
      dateKeys.forEach(dk=>{
        const rec = data[cfg.code];
        if(rec && rec.absent && rec.absent[dk]){
          const p = rec.present || 0;
          const t = rec.total || 0;
          tr.innerHTML += `<td class="main-row-cell"><span style="color:#2563eb;cursor:pointer" onclick="showAbsentInline_2B('${dk}','${cfg.code}',this)">${p}/${t}</span></td>`;
        } else {
          tr.innerHTML += `<td class="main-row-cell" style="color:#9ca3af">-</td>`;
        }
      });
      weeklyTableBody.appendChild(tr);
    });
  });
}

function loadMonthlySummary(){
  const monthDates = _getMonthDates_2B(today);
  const dateKeys = monthDates.map(d=>_formatDateKey_2B(d));

  monthlyDateRow.innerHTML = monthDates.map(d=>`<th>${d.getDate()}</th>`).join('');
  monthlyHeaderSpan.colSpan = monthDates.length;
  monthlyTableBody.innerHTML = '';

  const db = window.db || firebase.database();
  const monthKey = _getMonthKeyFromDateKey(dateKeys[0]);

  db.ref('monthlySummary/'+monthKey).once('value').then(snap=>{
    const data = snap.val() || {};
    let bil = 1;
    summaryConfig.forEach(cfg=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="main-row-cell">${bil++}</td><td class="main-row-cell">${cfg.darjah}</td><td class="main-row-cell">${cfg.kelasLabel}</td>`;
      dateKeys.forEach(dk=>{
        const rec = data[cfg.code];
        if(rec && rec.absent && rec.absent[dk]){
          const p = rec.present || 0;
          const t = rec.total || 0;
          tr.innerHTML += `<td class="main-row-cell"><span style="color:#2563eb;cursor:pointer" onclick="showAbsentInline_2B('${dk}','${cfg.code}',this)">${p}/${t}</span></td>`;
        } else {
          tr.innerHTML += `<td class="main-row-cell" style="color:#9ca3af">-</td>`;
        }
      });
      monthlyTableBody.appendChild(tr);
    });
  });
}

function showAbsentInline_2B(dateKey, classKey, el){
  const db = window.db || firebase.database();
  const weekKey = _getWeekKeyFromDateKey(dateKey);
  const monthKey = _getMonthKeyFromDateKey(dateKey);
  const existing = el.parentElement.querySelector('.absent-dropdown');
  if(existing){ existing.remove(); return; }

  const container = document.createElement('div');
  container.className = 'absent-dropdown';
  container.style.background = '#f9fafb';
  container.style.padding = '8px';
  container.style.marginTop = '6px';
  container.style.border = '1px solid #e5e7eb';
  container.style.borderRadius = '8px';

  db.ref('weeklySummary/'+weekKey+'/'+classKey+'/absent/'+dateKey).once('value').then(snap=>{
    let names = snap.val();
    if(!names){
      return db.ref('monthlySummary/'+monthKey+'/'+classKey+'/absent/'+dateKey).once('value');
    }
    return snap;
  }).then(s=>{
    const val = s && s.val ? s.val() : [];
    const arr = Array.isArray(val) ? val : (val && typeof val === 'object' ? Object.values(val) : []);
    if(arr.length){
      container.innerHTML = '<strong>Tidak hadir:</strong><br>' + arr.map((n,i)=>`${i+1}) ${n}`).join('<br>');
    } else {
      container.innerHTML = '<em>Tiada murid tidak hadir.</em>';
    }
    el.parentElement.appendChild(container);
  });
}

function getWeekKey(dateKey){
    const d = new Date(dateKey);
    const onejan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
    return d.getFullYear() + "-W" + String(week).padStart(2,'0');
}
</script>

</body>
</html>
